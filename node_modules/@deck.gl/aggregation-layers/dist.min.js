!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t(require("luma"),require("deck"));else if("function"==typeof define&&define.amd)define(["luma","deck"],t);else{var n="object"==typeof exports?t(require("luma"),require("deck")):t(e.luma,e.deck);for(var i in n)("object"==typeof exports?exports:e)[i]=n[i]}}(window,function(e,t){return function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=10)}([function(e,t){e.exports=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}},function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t){function n(t){return e.exports=n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},n(t)}e.exports=n},function(e,t){function n(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}e.exports=function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}},function(e,t){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},function(e,t,n){var i=n(13),r=n(14);e.exports=function(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?r(e):t}},function(e,t,n){var i=n(16);e.exports=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&i(e,t)}},function(e,t,n){n(3);var i=n(15);function r(t,n,o){return"undefined"!=typeof Reflect&&Reflect.get?e.exports=r=Reflect.get:e.exports=r=function(e,t,n){var r=i(e,t);if(r){var o=Object.getOwnPropertyDescriptor(r,t);return o.get?o.get.call(n):o.value}},r(t,n,o||t)}e.exports=r},function(e,t,n){var i=n(17),r=n(18),o=n(19);e.exports=function(e,t){return i(e)||r(e,t)||o()}},function(e,t,n){(function(t){const i=n(20),r=("undefined"==typeof window?t:window).deck||{};if(!r.LineLayer)throw new Error("@deck.gl/layers is not found");e.exports=Object.assign(r,i)}).call(this,n(12))},,function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(t){return"function"==typeof Symbol&&"symbol"===n(Symbol.iterator)?e.exports=i=function(e){return n(e)}:e.exports=i=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":n(e)},i(t)}e.exports=i},function(e,t){e.exports=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}},function(e,t,n){var i=n(3);e.exports=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=i(e)););return e}},function(e,t){function n(t,i){return e.exports=n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},n(t,i)}e.exports=n},function(e,t){e.exports=function(e){if(Array.isArray(e))return e}},function(e,t){e.exports=function(e,t){var n=[],i=!0,r=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);i=!0);}catch(e){r=!0,o=e}finally{try{i||null==s.return||s.return()}finally{if(r)throw o}}return n}},function(e,t){e.exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}},function(e,t,n){"use strict";n.r(t);var i=n(5),r=n.n(i),o=n(4),a=n.n(o),s=n(6),l=n.n(s),u=n(3),c=n.n(u),g=n(8),h=n.n(g),f=n(7),d=n.n(f),v=n(2),p=[[255,255,178],[254,217,118],[254,178,76],[253,141,60],[240,59,32],[189,0,38]],m=n(0),y=n.n(m),x=n(9),S=n.n(x),b=n(1),M=n.n(b);function C(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],i=!0,r=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);i=!0);}catch(e){r=!0,o=e}finally{try{i||null==s.return||s.return()}finally{if(r)throw o}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var w=1e-6,E="undefined"!=typeof Float32Array?Float32Array:Array;Math.random;Math.PI;function k(e,t,n){var i=t[0],r=t[1],o=t[2],a=t[3];return e[0]=n[0]*i+n[4]*r+n[8]*o+n[12]*a,e[1]=n[1]*i+n[5]*r+n[9]*o+n[13]*a,e[2]=n[2]*i+n[6]*r+n[10]*o+n[14]*a,e[3]=n[3]*i+n[7]*r+n[11]*o+n[15]*a,e}var P,A;P=new E(4),E!=Float32Array&&(P[0]=0,P[1]=0,P[2]=0,P[3]=0),A=P;function D(e,t){var n,i,r,o=k([],t,e);return n=o,i=o,r=1/o[3],n[0]=i[0]*r,n[1]=i[1]*r,n[2]=i[2]*r,n[3]=i[3]*r,o}function O(e,t,n){var i=t[0],r=t[1],o=t[2],a=t[3],s=t[4],l=t[5],u=t[6],c=t[7],g=t[8],h=t[9],f=t[10],d=t[11],v=t[12],p=t[13],m=t[14],y=t[15],x=n[0],S=n[1],b=n[2],M=n[3];return e[0]=x*i+S*s+b*g+M*v,e[1]=x*r+S*l+b*h+M*p,e[2]=x*o+S*u+b*f+M*m,e[3]=x*a+S*c+b*d+M*y,x=n[4],S=n[5],b=n[6],M=n[7],e[4]=x*i+S*s+b*g+M*v,e[5]=x*r+S*l+b*h+M*p,e[6]=x*o+S*u+b*f+M*m,e[7]=x*a+S*c+b*d+M*y,x=n[8],S=n[9],b=n[10],M=n[11],e[8]=x*i+S*s+b*g+M*v,e[9]=x*r+S*l+b*h+M*p,e[10]=x*o+S*u+b*f+M*m,e[11]=x*a+S*c+b*d+M*y,x=n[12],S=n[13],b=n[14],M=n[15],e[12]=x*i+S*s+b*g+M*v,e[13]=x*r+S*l+b*h+M*p,e[14]=x*o+S*u+b*f+M*m,e[15]=x*a+S*c+b*d+M*y,e}function T(e,t,n){var i,r,o,a,s,l,u,c,g,h,f,d,v=n[0],p=n[1],m=n[2];return t===e?(e[12]=t[0]*v+t[4]*p+t[8]*m+t[12],e[13]=t[1]*v+t[5]*p+t[9]*m+t[13],e[14]=t[2]*v+t[6]*p+t[10]*m+t[14],e[15]=t[3]*v+t[7]*p+t[11]*m+t[15]):(i=t[0],r=t[1],o=t[2],a=t[3],s=t[4],l=t[5],u=t[6],c=t[7],g=t[8],h=t[9],f=t[10],d=t[11],e[0]=i,e[1]=r,e[2]=o,e[3]=a,e[4]=s,e[5]=l,e[6]=u,e[7]=c,e[8]=g,e[9]=h,e[10]=f,e[11]=d,e[12]=i*v+s*p+g*m+t[12],e[13]=r*v+l*p+h*m+t[13],e[14]=o*v+u*p+f*m+t[14],e[15]=a*v+c*p+d*m+t[15]),e}function N(e,t,n){var i=n[0],r=n[1],o=n[2];return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*o,e[9]=t[9]*o,e[10]=t[10]*o,e[11]=t[11]*o,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function z(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t[4],a=t[5],s=t[6],l=t[7],u=t[8],c=t[9],g=t[10],h=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=o*r+u*i,e[5]=a*r+c*i,e[6]=s*r+g*i,e[7]=l*r+h*i,e[8]=u*r-o*i,e[9]=c*r-a*i,e[10]=g*r-s*i,e[11]=h*r-l*i,e}function _(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t[0],a=t[1],s=t[2],l=t[3],u=t[4],c=t[5],g=t[6],h=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*r+u*i,e[1]=a*r+c*i,e[2]=s*r+g*i,e[3]=l*r+h*i,e[4]=u*r-o*i,e[5]=c*r-a*i,e[6]=g*r-s*i,e[7]=h*r-l*i,e}function F(e,t,n,i,r){var o,a=1/Math.tan(t/2);return e[0]=a/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=r&&r!==1/0?(o=1/(i-r),e[10]=(r+i)*o,e[14]=2*r*i*o):(e[10]=-1,e[14]=-2*i),e}!function(){var e,t=(e=new E(2),E!=Float32Array&&(e[0]=0,e[1]=0),e)}();function L(e,t,n){var i=new E(3);return i[0]=e,i[1]=t,i[2]=n,i}function B(e,t){var n=t[0],i=t[1],r=t[2],o=n*n+i*i+r*r;return o>0&&(o=1/Math.sqrt(o)),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e}!function(){var e,t=(e=new E(3),E!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e)}();function j(e,t){if(!e)throw new Error(t||"viewport-mercator-project: assertion failed.")}var R;Math.PI;function I(e,t){var n=C(e,3),i=n[0],r=n[1],o=n[2],a=void 0===o?0:o;return j(Number.isFinite(i)&&Number.isFinite(r)&&Number.isFinite(a)),D(t,[i,r,a,1])}var W={SUM:1,MEAN:2,MIN:3,MAX:4},V={dataChanged:!0,viewportChanged:!0,cellSizeChanged:!0},U={changeFlags:V,projectPoints:!1,useGPU:!0,fp64:!1,viewport:null,gridTransformMatrix:null,createBufferObjects:!0},G=[M.a.MIN,M.a.FUNC_ADD],X=[M.a.MAX,M.a.FUNC_ADD],Y=[M.a.MAX,M.a.MIN],q=(R={},y()(R,W.SUM,M.a.FUNC_ADD),y()(R,W.MEAN,M.a.FUNC_ADD),y()(R,W.MIN,G),y()(R,W.MAX,X),R),H={size:1,operation:W.SUM,needMin:!1,needMax:!1,combineMaxMin:!1},Z=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];function Q(e,t){var n,i=t.width,r=void 0===i?1:i,o=t.height,a=void 0===o?1:o;return new b.Texture2D(e,{data:null,format:M.a.RGBA32F,type:M.a.FLOAT,border:0,mipmaps:!1,parameters:(n={},y()(n,M.a.TEXTURE_MAG_FILTER,M.a.NEAREST),y()(n,M.a.TEXTURE_MIN_FILTER,M.a.NEAREST),n),dataFormat:M.a.RGBA,width:r,height:a})}function K(e,t){var n=t.id,i=t.width,r=void 0===i?1:i,o=t.height,a=void 0===o?1:o,s=t.texture;return new b.Framebuffer(e,{id:n,width:r,height:a,attachments:y()({},M.a.COLOR_ATTACHMENT0,s)})}function J(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return!e||e.length<t?new Float32Array(t).fill(n):e}var $=b.fp64.fp64ifyMatrix4,ee=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};r()(this,e),this.id=n.id||"gpu-grid-aggregator",this.shaderCache=n.shaderCache||null,this.gl=t,this.state={weights:null,gridPositions:null,positionsBuffer:null,positions64xyLowBuffer:null,vertexCount:0,fp64:null,useGPU:null,numCol:0,numRow:0,windowSize:null,cellSize:null,weightAttributes:{},textures:{},meanTextures:{},buffers:{},framebuffers:{},maxMinFramebuffers:{},minFramebuffers:{},maxFramebuffers:{},equations:{},resources:{}},this._hasGPUSupport=Object(b.isWebGL2)(t)&&Object(b.hasFeatures)(this.gl,b.FEATURES.BLEND_EQUATION_MINMAX,b.FEATURES.COLOR_ATTACHMENT_RGBA32F,b.FEATURES.TEXTURE_FLOAT)}return a()(e,null,[{key:"getAggregationData",value:function(e){var t=e.aggregationData,n=e.maxData,i=e.pixelIndex;v.log.assert(t.length>=4*(i+1)),v.log.assert(4===n.length);var r=4*i;return{cellCount:t[r+3],cellWeight:t[r],totalCount:n[3],maxCellWieght:n[0]}}},{key:"getCellData",value:function(e){for(var t=e.countsData,n=e.size,i=void 0===n?1:n,r=t.length/4,o=new Float32Array(r*i),a=new Uint32Array(r),s=0;s<r;s++){for(var l=0;l<i;l++)o[s*i+l]=t[4*s+l];a[s]=t[4*s+3]}return{cellCounts:a,cellWeights:o}}}]),a()(e,[{key:"delete",value:function(){var e=this.gridAggregationModel,t=this.allAggregationModel,n=this.meanTransform,i=this.state,r=i.positionsBuffer,o=i.position64Buffer,a=i.textures,s=i.framebuffers,l=i.maxMinFramebuffers,u=i.minFramebuffers,c=i.maxFramebuffers,g=i.meanTextures,h=i.resources;e&&e.delete(),t&&t.delete(),n&&n.delete(),r&&r.delete(),o&&o.delete(),this.deleteResources([s,a,l,u,c,g,h])}},{key:"run",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this.getAggregationParams(e);this.updateGridSize(t);var n=t.useGPU;return this._hasGPUSupport&&n?this.runAggregationOnGPU(t):(n&&v.log.warn("ScreenGridAggregator: GPU Aggregation not supported, falling back to CPU")(),this.runAggregationOnCPU(t))}},{key:"deleteResources",value:function(e){(e=Array.isArray(e)?e:[e]).forEach(function(e){for(var t in e)e[t].delete()})}},{key:"getAggregationParams",value:function(e){var t=Object.assign({},U,e),n=t.useGPU,i=t.gridTransformMatrix,r=t.viewport,o=t.weights,a=t.projectPoints,s=t.cellSize;return this.state.useGPU!==n&&(t.changeFlags=Object.assign({},t.changeFlags,V)),!s||this.state.cellSize&&this.state.cellSize[0]===s[0]&&this.state.cellSize[1]===s[1]||(t.changeFlags.cellSizeChanged=!0,this.setState({cellSize:s})),this.validateProps(t,e),this.setState({useGPU:n}),t.gridTransformMatrix=(a?r.viewportMatrix:i)||Z,o&&(t.weights=this.normalizeWeightParams(o),this.setState({weights:t.weights})),t}},{key:"normalizeWeightParams",value:function(e){var t={};for(var n in e)t[n]=Object.assign({},H,e[n]);return t}},{key:"setState",value:function(e){Object.assign(this.state,e)}},{key:"shouldTransformToGrid",value:function(e){var t=e.projectPoints,n=e.changeFlags;return!!(!this.state.gridPositions||n.dataChanged||t&&n.viewportChanged)}},{key:"updateGridSize",value:function(e){var t=e.viewport,n=e.cellSize,i=e.width||t.width,r=e.height||t.height,o=Math.ceil(i/n[0]),a=Math.ceil(r/n[1]);this.setState({numCol:o,numRow:a,windowSize:[i,r]})}},{key:"validateProps",value:function(e,t){var n=e.changeFlags,i=e.projectPoints,r=e.gridTransformMatrix;v.log.assert(n.dataChanged||n.viewportChanged||n.cellSizeChanged),v.log.assert(!n.dataChanged||t.positions&&t.weights&&(!t.projectPositions||t.viewport)&&t.cellSize),v.log.assert(!n.cellSizeChanged||t.cellSize),v.log.assert(!(n.viewportChanged&&i)||t.viewport),i&&r&&v.log.warn("projectPoints is true, gridTransformMatrix is ignored")()}},{key:"calculateAggregationData",value:function(e){var t=e.weights,n=e.results,i=e.cellIndex,r=e.posIndex;for(var o in t){for(var a=t[o],s=a.values,l=a.size,u=a.operation,c=n[o].aggregationData,g=0;g<l;g++){var h=i+g,f=s[3*r+g];if(0===c[i+3])c[h]=f;else switch(u){case W.SUM:case W.MEAN:c[h]+=f;break;case W.MIN:c[h]=Math.min(c[h],f);break;case W.MAX:c[h]=Math.max(c[h],f);break;default:v.log.assert(!1)}}c[i+3]++}}},{key:"calculateMeanMaxMinData",value:function(e){var t=e.validCellIndices,n=e.results,i=e.weights;t.forEach(function(e){for(var t in n){for(var r=i[t],o=r.size,a=r.needMin,s=r.needMax,l=r.operation,u=n[t],c=u.aggregationData,g=u.minData,h=u.maxData,f=u.maxMinData,d=a||s,v=l===W.MEAN,p=a&&s&&i[t].combineMaxMin,m=c[e+4-1],y=0;y<o&&(d||v);y++){var x=e+y,S=c[x];v&&(c[x]/=m,S=c[x]),p?f[y]=Math.max(f[y],S):(a&&(g[y]=Math.min(g[y],S)),s&&(h[y]=Math.max(h[y],S)))}p?f[3]=Math.min(f[3],c[e+0]):(a&&(g[3]+=m),s&&(h[3]+=m))}})}},{key:"initCPUResults",value:function(e){var t=e.weights||this.state.weights,n=this.state,i=n.numCol,r=n.numRow,o={};for(var a in t){var s=t[a],l=s.aggregationData,u=s.minData,c=s.maxData,g=s.maxMinData,h=t[a],f=h.needMin,d=h.needMax,v=f&&d&&t[a].combineMaxMin;l=J(l,i*r*4),v?((g=J(g,4)).fill(-1/0,0,3),g[3]=1/0):(f&&((u=J(u,4,1/0))[3]=0),d&&((c=J(c,4,-1/0))[3]=0)),o[a]=Object.assign({},t[a],{aggregationData:l,minData:u,maxData:c,maxMinData:g})}return o}},{key:"runAggregationOnCPU",value:function(e){var t,n,i=e.positions,r=e.cellSize,o=e.gridTransformMatrix,a=e.viewport,s=e.projectPoints,l=e.weights,u=this.state,c=u.numCol,g=u.numRow,h=this.initCPUResults(e),f=this.shouldTransformToGrid(e),d=[0,0,0];v.log.assert(f||e.changeFlags.cellSizeChanged),f?(n=i.length/2,t=new Float64Array(i.length),this.setState({gridPositions:t})):(t=this.state.gridPositions,l=this.state.weights,n=t.length/2);for(var p=new Set,m=0;m<n;m++){var y=void 0,x=void 0;if(f){if(d[0]=i[2*m],d[1]=i[2*m+1],s){var b=a.project(d),M=S()(b,2);y=M[0],x=M[1]}else{var C=I(d,o),w=S()(C,2);y=w[0],x=w[1]}t[2*m]=y,t[2*m+1]=x}else y=t[2*m],x=t[2*m+1];var E=Math.floor(y/r[0]),k=Math.floor(x/r[1]);if(E>=0&&E<c&&k>=0&&k<g){var P=4*(E+k*c);p.add(P),this.calculateAggregationData({weights:l,results:h,cellIndex:P,posIndex:m})}}return this.calculateMeanMaxMinData({validCellIndices:p,results:h,weights:l}),this.updateAggregationBuffers(e,h),h}},{key:"updateResultBuffer",value:function(e){var t=e.gl,n=e.bufferName,i=e.id,r=e.data,o=e.result,a=this.state.resources,s="".concat(i,"-").concat(n);o[n]=o[n]||a[s],o[n]?o[n].subData({data:r}):(a[s]=new b.Buffer(t,r),o[n]=a[s])}},{key:"updateAggregationBuffers",value:function(e,t){if(e.createBufferObjects){var n=e.weights||this.state.weights;for(var i in t){var r=t[i],o=r.aggregationData,a=r.minData,s=r.maxData,l=r.maxMinData,u=n[i],c=u.needMin,g=u.needMax,h=c&&g&&n[i].combineMaxMin;this.updateResultBuffer({gl:this.gl,bufferName:"aggregationBuffer",id:i,data:o,result:t[i]}),h?this.updateResultBuffer({gl:this.gl,bufferName:"maxMinBuffer",id:i,data:l,result:t[i]}):(c&&this.updateResultBuffer({gl:this.gl,bufferName:"minBuffer",id:i,data:a,result:t[i]}),g&&this.updateResultBuffer({gl:this.gl,bufferName:"maxBuffer",id:i,data:s,result:t[i]}))}}}},{key:"getAggregateData",value:function(e){var t={},n=this.state,i=n.textures,r=n.framebuffers,o=n.maxMinFramebuffers,a=n.minFramebuffers,s=n.maxFramebuffers,l=n.weights;for(var u in l){t[u]={};var c=l[u],g=c.needMin,h=c.needMax,f=c.combineMaxMin;t[u].aggregationTexture=i[u],t[u].aggregationBuffer=Object(b.readPixelsToBuffer)(r[u],{target:l[u].aggregationBuffer,sourceType:M.a.FLOAT}),g&&h&&f?t[u].maxMinBuffer=Object(b.readPixelsToBuffer)(o[u],{target:l[u].maxMinBuffer,sourceType:M.a.FLOAT}):(g&&(t[u].minBuffer=Object(b.readPixelsToBuffer)(a[u],{target:l[u].minBuffer,sourceType:M.a.FLOAT})),h&&(t[u].maxBuffer=Object(b.readPixelsToBuffer)(s[u],{target:l[u].maxBuffer,sourceType:M.a.FLOAT})))}return t}},{key:"getAggregationModel",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.gl,n=this.shaderCache;return new b.Model(t,{id:"Gird-Aggregation-Model",vs:e?"#define SHADER_NAME gpu-aggregation-to-grid-vs-64\n\nattribute vec2 positions;\nattribute vec2 positions64xyLow;\nattribute vec3 weights;\nuniform vec2 windowSize;\nuniform vec2 cellSize;\nuniform vec2 gridSize;\nuniform vec2 uProjectionMatrixFP64[16];\nuniform bool projectPoints;\n\nvarying vec3 vWeights;\n\nvoid project_to_pixel(vec2 pos, vec2 pos64xyLow, out vec2 pixelXY64[2]) {\n\n  vec2 result64[4];\n  vec2 position64[4];\n  position64[0] = vec2(pos.x, pos64xyLow.x);\n  position64[1] = vec2(pos.y, pos64xyLow.y);\n  position64[2] = vec2(0., 0.);\n  position64[3] = vec2(1., 0.);\n  mat4_vec4_mul_fp64(uProjectionMatrixFP64, position64,\n  result64);\n\n  pixelXY64[0] = div_fp64(result64[0], result64[3]);\n  pixelXY64[1] = div_fp64(result64[1], result64[3]);\n}\n\nvoid main(void) {\n\n  vWeights = weights;\n\n  vec2 windowPos = positions;\n  vec2 windowPos64xyLow = positions64xyLow;\n  if (projectPoints) {\n    vec2 projectedXY[2];\n    project_position_fp64(windowPos, windowPos64xyLow, projectedXY);\n    windowPos.x = projectedXY[0].x;\n    windowPos.y = projectedXY[1].x;\n    windowPos64xyLow.x = projectedXY[0].y;\n    windowPos64xyLow.y = projectedXY[1].y;\n  }\n\n  vec2 pixelXY64[2];\n  project_to_pixel(windowPos, windowPos64xyLow, pixelXY64);\n\n  // Transform (0,0):windowSize -> (0, 0): gridSize\n  vec2 gridXY64[2];\n  gridXY64[0] = div_fp64(pixelXY64[0], vec2(cellSize.x, 0));\n  gridXY64[1] = div_fp64(pixelXY64[1], vec2(cellSize.y, 0));\n  float x = floor(gridXY64[0].x);\n  float y = floor(gridXY64[1].x);\n  vec2 pos = vec2(x, y);\n\n  // Transform (0,0):gridSize -> (-1, -1):(1,1)\n  pos = (pos * (2., 2.) / (gridSize)) - (1., 1.);\n\n  // Move to pixel center, pixel-size in screen sapce (2/gridSize) * 0.5 => 1/gridSize\n  vec2 offset = 1.0 / gridSize;\n  pos = pos + offset;\n\n  gl_Position = vec4(pos, 0.0, 1.0);\n}\n":"#define SHADER_NAME gpu-aggregation-to-grid-vs\n\nattribute vec2 positions;\nattribute vec3 weights;\nuniform vec2 windowSize;\nuniform vec2 cellSize;\nuniform vec2 gridSize;\nuniform mat4 uProjectionMatrix;\nuniform bool projectPoints;\n\nvarying vec3 vWeights;\n\nvec2 project_to_pixel(vec4 pos) {\n  vec4 result =  uProjectionMatrix * pos;\n  return result.xy/result.w;\n}\n\nvoid main(void) {\n\n  vWeights = weights;\n\n  vec4 windowPos = vec4(positions, 0, 1.);\n  if (projectPoints) {\n    windowPos = project_position_to_clipspace(vec3(positions, 0), vec2(0, 0), vec3(0, 0, 0));\n  }\n\n  vec2 pos = project_to_pixel(windowPos);\n\n  // Transform (0,0):windowSize -> (0, 0): gridSize\n  pos = floor(pos / cellSize);\n\n  // Transform (0,0):gridSize -> (-1, -1):(1,1)\n  pos = (pos * (2., 2.) / (gridSize)) - (1., 1.);\n\n  // Move to pixel center, pixel-size in screen sapce (2/gridSize) * 0.5 => 1/gridSize\n  vec2 offset = 1.0 / gridSize;\n  pos = pos + offset;\n\n  gl_Position = vec4(pos, 0.0, 1.0);\n}\n",fs:"#define SHADER_NAME gpu-aggregation-to-grid-fs\n\nprecision highp float;\n\nvarying vec3 vWeights;\n\nvoid main(void) {\n  gl_FragColor = vec4(vWeights, 1.0);\n}\n",modules:e?["fp64","project64"]:["project32"],shaderCache:n,vertexCount:0,drawMode:M.a.POINTS})}},{key:"getAllAggregationModel",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0];var e=this.gl,t=this.shaderCache;return new b.Model(e,{id:"All-Aggregation-Model",vs:"#version 300 es\n#define SHADER_NAME gpu-aggregation-all-vs-64\n\nin vec2 position;\nuniform vec2 gridSize;\n\nout vec2 vTextureCoord;\nvoid main(void) {\n  // Map each position to single pixel\n  vec2 pos = vec2(-1.0, -1.0);\n\n  // Move to pixel center, pixel-size in screen sapce (2/gridSize) * 0.5 => 1/gridSize\n  vec2 offset = 1.0 / gridSize;\n  pos = pos + offset;\n\n  gl_Position = vec4(pos, 0.0, 1.0);\n\n  float yIndex = floor(float(gl_InstanceID) / gridSize[0]);\n  float xIndex = float(gl_InstanceID) - (yIndex * gridSize[0]);\n\n  vec2 yIndexFP64 = vec2(yIndex, 0.);\n  vec2 xIndexFP64 = vec2(xIndex, 0.);\n  vec2 gridSizeYFP64 = vec2(gridSize[1], 0.);\n  vec2 gridSizeXFP64 = vec2(gridSize[0], 0.);\n\n  vec2 texCoordXFP64 = div_fp64(yIndexFP64, gridSizeYFP64);\n  vec2 texCoordYFP64 = div_fp64(xIndexFP64, gridSizeXFP64);\n\n  vTextureCoord = vec2(texCoordYFP64.x, texCoordXFP64.x);\n}\n",fs:"#version 300 es\n#define SHADER_NAME gpu-aggregation-all-fs\n\nprecision highp float;\n\nin vec2 vTextureCoord;\nuniform sampler2D uSampler;\nuniform bool combineMaxMin;\nout vec4 fragColor;\nvoid main(void) {\n  vec4 textureColor = texture(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n  if (textureColor.a == 0.) {\n    discard;\n  }\n  fragColor.rgb = textureColor.rgb;\n  // if combineMinMax is true, use Alpha channel for first weights min value.\n  fragColor.a = combineMaxMin ? textureColor.r : textureColor.a;\n}\n",modules:["fp64"],shaderCache:t,vertexCount:1,drawMode:M.a.POINTS,isInstanced:!0,instanceCount:0,attributes:{position:[0,0]}})}},{key:"getMeanTransform",value:function(e){return this.meanTransform?this.meanTransform.update(e):this.meanTransform=new b.Transform(this.gl,Object.assign({},{vs:"#define SHADER_NAME gpu-aggregation-transform-mean-vs\nattribute vec4 aggregationValues;\nvarying vec4 meanValues;\n\nvoid main()\n{\n  // TODO: Use 64-bit division ?? not needed given this is aggregation ??\n  bool isCellValid = bool(aggregationValues.w > 0.);\n  // aggregationValues:  XYZ contain aggregated values, W contains count\n  meanValues.xyz = isCellValid ? aggregationValues.xyz/aggregationValues.w : vec3(0, 0, 0);\n  meanValues.w = aggregationValues.w;\n}\n",_targetTextureVarying:"meanValues"},e)),this.meanTransform}},{key:"renderAggregateData",value:function(e){var t=e.cellSize,n=e.viewport,i=e.gridTransformMatrix,r=e.projectPoints,o=this.state,a=o.numCol,s=o.numRow,l=o.windowSize,u=o.maxMinFramebuffers,c=o.minFramebuffers,g=o.maxFramebuffers,h=o.weights,f=$(i),d=[a,s],v={blend:!0,depthTest:!1,blendFunc:[M.a.ONE,M.a.ONE]},p={viewport:n},m={windowSize:l,cellSize:t,gridSize:d,uProjectionMatrix:i,uProjectionMatrixFP64:f,projectPoints:r};for(var y in h){var x=h[y],S=x.needMin,b=x.needMax,C=S&&b&&h[y].combineMaxMin;this.renderToWeightsTexture({id:y,parameters:v,moduleSettings:p,uniforms:m,gridSize:d}),C?this.renderToMaxMinTexture({id:y,parameters:Object.assign({},v,{blendEquation:Y}),gridSize:d,minOrMaxFb:u[y],clearParams:{clearColor:[0,0,0,3.402823466e38]},combineMaxMin:C}):(S&&this.renderToMaxMinTexture({id:y,parameters:Object.assign({},v,{blendEquation:G}),gridSize:d,minOrMaxFb:c[y],clearParams:{clearColor:[3.402823466e38,3.402823466e38,3.402823466e38,0]},combineMaxMin:C}),b&&this.renderToMaxMinTexture({id:y,parameters:Object.assign({},v,{blendEquation:X}),gridSize:d,minOrMaxFb:g[y],combineMaxMin:C}))}}},{key:"renderToMaxMinTexture",value:function(e){var t=e.id,n=e.parameters,i=e.gridSize,r=e.minOrMaxFb,o=e.combineMaxMin,a=e.clearParams,s=void 0===a?{}:a,l=this.state.framebuffers,u=this.gl,c=this.allAggregationModel;r.bind(),u.viewport(0,0,i[0],i[1]),Object(b.withParameters)(u,s,function(){u.clear(u.COLOR_BUFFER_BIT)}),c.draw({parameters:n,uniforms:{uSampler:l[t].texture,gridSize:i,combineMaxMin:o}}),r.unbind()}},{key:"renderToWeightsTexture",value:function(e){var t=e.id,n=e.parameters,i=e.moduleSettings,r=e.uniforms,o=e.gridSize,a=this.state,s=a.framebuffers,l=a.equations,u=a.weightAttributes,c=a.weights,g=this.gl,h=this.gridAggregationModel,f=c[t].operation;s[t].bind(),g.viewport(0,0,o[0],o[1]);var d=f===W.MIN?[3.402823466e38,3.402823466e38,3.402823466e38,0]:[0,0,0,0];Object(b.withParameters)(g,{clearColor:d},function(){g.clear(g.COLOR_BUFFER_BIT)});var v={weights:u[t]};if(h.draw({parameters:Object.assign({},n,{blendEquation:l[t]}),moduleSettings:i,uniforms:r,attributes:v}),s[t].unbind(),f===W.MEAN){var p=this.state,m=p.meanTextures,x=p.textures,S={_sourceTextures:{aggregationValues:m[t]},_targetTexture:x[t],elementCount:x[t].width*x[t].height};this.getMeanTransform(S).run({parameters:{blend:!1,depthTest:!1}}),s[t].attach(y()({},M.a.COLOR_ATTACHMENT0,x[t]))}}},{key:"runAggregationOnGPU",value:function(e){return this.updateModels(e),this.setupFramebuffers(e),this.renderAggregateData(e),this.getAggregateData(e)}},{key:"setupFramebuffers",value:function(e){var t=this.state,n=t.numCol,i=t.numRow,r=t.textures,o=t.framebuffers,a=t.maxMinFramebuffers,s=t.minFramebuffers,l=t.maxFramebuffers,u=t.resources,c=t.meanTextures,g=t.equations,h=t.weights,f={width:n,height:i};for(var d in h){var v=h[d],p=v.needMin,m=v.needMax,x=v.combineMaxMin,S=v.operation;r[d]=h[d].aggregationTexture||r[d]||Q(this.gl,{id:"".concat(d,"-texture"),width:n,height:i}),r[d].resize(f);var b=r[d];S===W.MEAN&&(c[d]=c[d]||Q(this.gl,{id:"".concat(d,"-mean-texture"),width:n,height:i}),c[d].resize(f),b=c[d]),o[d]?o[d].attach(y()({},M.a.COLOR_ATTACHMENT0,b)):o[d]=K(this.gl,{id:"".concat(d,"-fb"),width:n,height:i,texture:b}),o[d].resize(f),g[d]=q[S],(p||m)&&(p&&m&&x?a[d]||(u["".concat(d,"-maxMin")]=Q(this.gl,{id:"".concat(d,"-maxMinTex")}),a[d]=K(this.gl,{id:"".concat(d,"-maxMinFb"),texture:u["".concat(d,"-maxMin")]})):(p&&(s[d]||(u["".concat(d,"-min")]=Q(this.gl,{id:"".concat(d,"-minTex")}),s[d]=K(this.gl,{id:"".concat(d,"-minFb"),texture:u["".concat(d,"-min")]}))),m&&(l[d]||(u["".concat(d,"-max")]=Q(this.gl,{id:"".concat(d,"-maxTex")}),l[d]=K(this.gl,{id:"".concat(d,"-maxFb"),texture:u["".concat(d,"-max")]})))))}}},{key:"setupModels",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.gridAggregationModel&&this.gridAggregationModel.delete(),this.gridAggregationModel=this.getAggregationModel(e),this.allAggregationModel&&this.allAggregationModel.delete(),this.allAggregationModel=this.getAllAggregationModel(e)}},{key:"setupWeightAttributes",value:function(e){var t=this.state,n=t.weightAttributes,i=t.vertexCount,r=t.weights,o=t.resources;for(var a in r){var s=r[a].values;if(Array.isArray(s)||s.constructor===Float32Array){v.log.assert(s.length/3===i);var l=Array.isArray(s)?new Float32Array(s):s;n[a]instanceof b.Buffer?n[a].setData(l):(o["".concat(a,"-buffer")]=new b.Buffer(this.gl,l),n[a]=o["".concat(a,"-buffer")])}else v.log.assert(s instanceof b.Buffer),n[a]=s}}},{key:"updateModels",value:function(e){var t=this.gl,n=e.positions,i=e.positions64xyLow,r=e.changeFlags,o=this.state,a=o.numCol,s=o.numRow,l=this.state,u=l.positionsBuffer,c=l.positions64xyLowBuffer,g={},h=!1;if(e.fp64!==this.state.fp64&&(this.setupModels(e.fp64),this.setState({fp64:e.fp64}),e.fp64&&(h=!0)),r.dataChanged||!u){u&&u.delete();var f=n.length/2;u=new b.Buffer(t,new Float32Array(n)),h=e.fp64,Object.assign(g,{positions:u}),this.setState({positionsBuffer:u,vertexCount:f}),this.setupWeightAttributes(e),this.gridAggregationModel.setVertexCount(f)}h&&(v.log.assert(i),c&&c.delete(),c=new b.Buffer(t,{size:2,data:new Float32Array(i)}),Object.assign(g,{positions64xyLow:c}),this.setState({positions64xyLowBuffer:c})),this.gridAggregationModel.setAttributes(g),(r.cellSizeChanged||r.viewportChanged)&&this.allAggregationModel.setInstanceCount(a*s)}}]),e}(),te=v.experimental.count,ne=[0,0,0,0],ie=[0,255,0,255],re=["minColor","maxColor","colorRange","colorDomain"],oe={cellSizePixels:{value:100,min:1},cellMarginPixels:{value:2,min:0,max:5},colorDomain:null,colorRange:p,getPosition:{type:"accessor",value:function(e){return e.position}},getWeight:{type:"accessor",value:function(e){return[1,0,0]}},gpuAggregation:!0,aggregation:"SUM"},ae=function(e){function t(){return r()(this,t),l()(this,c()(t).apply(this,arguments))}return d()(t,e),a()(t,[{key:"getShaders",value:function(){var e=Object(b.isWebGL2)(this.context.gl)?{vs:"#version 300 es\n#define SHADER_NAME screen-grid-layer-vertex-shader\n#define RANGE_COUNT 6\n\nin vec3 positions;\nin vec3 instancePositions;\nin vec4 instanceCounts;\nin vec3 instancePickingColors;\n\nlayout(std140) uniform;\nuniform float opacity;\nuniform vec3 cellScale;\nuniform vec4 minColor;\nuniform vec4 maxColor;\nuniform AggregationData\n{\n  vec4 maxCount;\n} aggregationData;\n\nuniform vec4 colorRange[RANGE_COUNT];\nuniform vec2 colorDomain;\nuniform bool shouldUseMinMax;\n\nout vec4 vColor;\nout float vSampleCount;\n\nvec4 quantizeScale(vec2 domain, vec4 range[RANGE_COUNT], float value) {\n  vec4 outColor = vec4(0., 0., 0., 0.);\n  if (value >= domain.x && value <= domain.y) {\n    float domainRange = domain.y - domain.x;\n    if (domainRange <= 0.) {\n      outColor = colorRange[0];\n    } else {\n      float rangeCount = float(RANGE_COUNT);\n      float rangeStep = domainRange / rangeCount;\n      float idx = floor((value - domain.x) / rangeStep);\n      idx = clamp(idx, 0., rangeCount - 1.);\n      int intIdx = int(idx);\n      outColor = colorRange[intIdx];\n    }\n  }\n  outColor = outColor / 255.;\n  return outColor;\n}\n\nvoid main(void) {\n  vSampleCount = instanceCounts.a;\n\n  float weight = instanceCounts.r ;\n  float maxWeight = aggregationData.maxCount.r;\n  float step = weight / maxWeight;\n  vec4 minMaxColor = mix(minColor, maxColor, step) / 255.;\n\n  vec2 domain = colorDomain;\n  float domainMaxValid = float(colorDomain.y != 0.);\n  domain.y = mix(maxWeight, colorDomain.y, domainMaxValid);\n  vec4 rangeColor = quantizeScale(domain, colorRange, weight);\n\n  float rangeMinMax = float(shouldUseMinMax);\n  vec4 color = mix(rangeColor, minMaxColor, rangeMinMax);\n  vColor = vec4(color.rgb, color.a * opacity);\n\n  // Set color to be rendered to picking fbo (also used to check for selection highlight).\n  picking_setPickingColor(instancePickingColors);\n\n  gl_Position = vec4(instancePositions + positions * cellScale, 1.);\n}\n",fs:"#version 300 es\n#define SHADER_NAME screen-grid-layer-fragment-shader\n\nprecision highp float;\n\nin vec4 vColor;\nin float vSampleCount;\nout vec4 fragColor;\n\nvoid main(void) {\n  if (vSampleCount <= 0.0) {\n    discard;\n  }\n  fragColor = vColor;\n\n  fragColor = picking_filterColor(fragColor);\n}\n"}:{vs:"#define SHADER_NAME screen-grid-layer-vertex-shader-webgl1\n#define RANGE_COUNT 6\n\nattribute vec3 positions;\nattribute vec3 instancePositions;\nattribute vec4 instanceCounts;\nattribute vec3 instancePickingColors;\n\nuniform float opacity;\nuniform vec3 cellScale;\nuniform vec4 minColor;\nuniform vec4 maxColor;\nuniform float maxWeight;\nuniform vec4 colorRange[RANGE_COUNT];\nuniform vec2 colorDomain;\nuniform bool shouldUseMinMax;\n\nvarying vec4 vColor;\nvarying float vSampleCount;\n\nvec4 quantizeScale(vec2 domain, vec4 range[RANGE_COUNT], float value) {\n  vec4 outColor = vec4(0., 0., 0., 0.);\n  if (value >= domain.x && value <= domain.y) {\n    float domainRange = domain.y - domain.x;\n    if (domainRange <= 0.) {\n      outColor = colorRange[0];\n    } else {\n      float rangeCount = float(RANGE_COUNT);\n      float rangeStep = domainRange / rangeCount;\n      float idx = floor((value - domain.x) / rangeStep);\n      idx = clamp(idx, 0., rangeCount - 1.);\n      int intIdx = int(idx);\n      outColor = colorRange[intIdx];\n    }\n  }\n  outColor = outColor / 255.;\n  return outColor;\n}\n\nvoid main(void) {\n  vSampleCount = instanceCounts.a;\n\n  float weight = instanceCounts.r;\n  float step = weight / maxWeight;\n  vec4 minMaxColor = mix(minColor, maxColor, step) / 255.;\n\n  vec2 domain = colorDomain;\n  float domainMaxValid = float(colorDomain.y != 0.);\n  domain.y = mix(maxWeight, colorDomain.y, domainMaxValid);\n  vec4 rangeColor = quantizeScale(domain, colorRange, weight);\n\n  float rangeMinMax = float(shouldUseMinMax);\n  vec4 color = mix(rangeColor, minMaxColor, rangeMinMax);\n  vColor = vec4(color.rgb, color.a * opacity);\n\n  // Set color to be rendered to picking fbo (also used to check for selection highlight).\n  picking_setPickingColor(instancePickingColors);\n\n  gl_Position = vec4(instancePositions + positions * cellScale, 1.);\n}\n",fs:"#define SHADER_NAME screen-grid-layer-fragment-shader-webgl1\n\nprecision highp float;\n\nvarying vec4 vColor;\nvarying float vSampleCount;\n\nvoid main(void) {\n  if (vSampleCount <= 0.0) {\n    discard;\n  }\n  gl_FragColor = vColor;\n\n  gl_FragColor = picking_filterColor(gl_FragColor);\n}\n"};return e.modules=["picking"],e}},{key:"initializeState",value:function(){var e=this.getAttributeManager(),t=this.context.gl;e.addInstanced({instancePositions:{size:3,update:this.calculateInstancePositions},instanceCounts:{size:4,transition:!0,accessor:["getPosition","getWeight"],update:this.calculateInstanceCounts,noAlloc:!0}});var n={id:"".concat(this.id,"-aggregator"),shaderCache:this.context.shaderCache},i=this._getMaxCountBuffer(t),r={color:{size:1,operation:W.SUM,needMax:!0,maxBuffer:i}};this.setState({model:this._getModel(t),gpuGridAggregator:new ee(t,n),maxBuffer:i,weights:r,aggregationResults:null}),this._setupUniformBuffer()}},{key:"shouldUpdateState",value:function(e){return e.changeFlags.somethingChanged}},{key:"updateState",value:function(e){h()(c()(t.prototype),"updateState",this).call(this,e),this._updateUniforms(e),e.changeFlags.dataChanged&&this._processData();var n=this._getAggregationChangeFlags(e);n&&this._updateAggregation(n)}},{key:"finalizeState",value:function(){h()(c()(t.prototype),"finalizeState",this).call(this);var e=this.state,n=e.aggregationBuffer,i=e.maxBuffer;e.gpuGridAggregator.delete(),n&&n.delete(),i&&i.delete()}},{key:"draw",value:function(e){var t=e.uniforms,n=this.context.gl,i=this.props.parameters,r=void 0===i?{}:i,o=this.props.minColor||ne,a=this.props.maxColor||ie,s=this.props.colorDomain||[1,0],l=this.state,u=l.model,c=l.maxBuffer,g=l.cellScale,h=l.shouldUseMinMax,f=l.colorRange,d=l.maxWeight,v={minColor:o,maxColor:a,cellScale:g,colorRange:f,colorDomain:s,shouldUseMinMax:h};Object(b.isWebGL2)(n)?c.bind({target:M.a.UNIFORM_BUFFER}):v.maxWeight=d,t=Object.assign(v,t),u.draw({uniforms:t,parameters:Object.assign({depthTest:!1,depthMask:!1},r)}),Object(b.isWebGL2)(n)&&c.unbind()}},{key:"calculateInstancePositions",value:function(e,t){for(var n=t.numInstances,i=this.context.viewport,r=i.width,o=i.height,a=this.props.cellSizePixels,s=this.state.numCol,l=e.value,u=e.size,c=0;c<n;c++){var g=c%s,h=Math.floor(c/s);l[c*u+0]=g*a/r*2-1,l[c*u+1]=1-h*a/o*2,l[c*u+2]=0}}},{key:"calculateInstanceCounts",value:function(e,t){t.numInstances;var n=this.state.aggregationBuffer;e.update({buffer:n})}},{key:"getPickingInfo",value:function(e){var t=e.info,n=(e.mode,t.index);if(n>=0){var i=this.state.aggregationResults;i.aggregationData=i.aggregationData||this.state.aggregationBuffer.getData(),i.maxData=i.maxData||this.state.maxBuffer.getData();var r=i.aggregationData,o=i.maxData;t.object=ee.getAggregationData({aggregationData:r,maxData:o,pixelIndex:n})}return t}},{key:"_getAggregationChangeFlags",value:function(e){var t=e.oldProps,n=e.props,i=e.changeFlags,r=n.cellSizePixels!==t.cellSizePixels||n.cellMarginPixels!==t.cellMarginPixels,o=i.dataChanged||n.aggregation!==t.aggregation,a=i.viewportChanged;return r||o||a?{cellSizeChanged:r,dataChanged:o,viewportChanged:a}:null}},{key:"_getModel",value:function(e){return new b.Model(e,Object.assign({},this.getShaders(),{id:this.props.id,geometry:new b.Geometry({drawMode:M.a.TRIANGLE_FAN,attributes:{positions:new Float32Array([0,0,0,1,0,0,1,1,0,0,1,0])}}),isInstanced:!0,shaderCache:this.context.shaderCache}))}},{key:"_getMaxCountBuffer",value:function(e){return new b.Buffer(e,{byteLength:16,index:0,accessor:{size:4}})}},{key:"_processData",value:function(){var e=this.props,t=e.data,n=e.getPosition,i=e.getWeight,r=te(t),o=new Float64Array(2*r),a=new Float32Array(3*r),s=this.state.weights,l=Object(v.createIterable)(t),u=l.iterable,c=l.objectInfo,g=!0,h=!1,f=void 0;try{for(var d,p=u[Symbol.iterator]();!(g=(d=p.next()).done);g=!0){var m=d.value;c.index++;var y=n(m,c),x=i(m,c),S=c.index;o[2*S]=y[0],o[2*S+1]=y[1],Array.isArray(x)?(a[3*S]=x[0],a[3*S+1]=x[1],a[3*S+2]=x[2]):a[3*S]=x}}catch(e){h=!0,f=e}finally{try{g||null==p.return||p.return()}finally{if(h)throw f}}s.color.values=a,this.setState({positions:o})}},{key:"_setupUniformBuffer",value:function(){var e=this.context.gl;if(Object(b.isWebGL2)(e)){var t=this.state.model.program.handle,n=e.getUniformBlockIndex(t,"AggregationData");e.uniformBlockBinding(t,n,0)}}},{key:"_shouldUseMinMax",value:function(){var e=this.props,t=e.minColor,n=e.maxColor,i=e.colorDomain,r=e.colorRange;return t||n?(v.log.deprecated("ScreenGridLayer props: minColor and maxColor","colorRange, colorDomain")(),!0):!i&&!r}},{key:"_updateAggregation",value:function(e){var t=this.getAttributeManager();(e.cellSizeChanged||e.viewportChanged)&&(this._updateGridParams(),t.invalidateAll());var n=this.props,i=n.cellSizePixels,r=n.gpuAggregation,o=this.state,a=o.positions,s=o.weights,l=this.context.viewport;s.color.operation=W[this.props.aggregation.toUpperCase()]||W.SUM;var u=!1,c=null;this.context.viewport instanceof v.WebMercatorViewport?u=!0:(u=!1,c=l.pixelProjectionMatrix);var g=this.state.gpuGridAggregator.run({positions:a,weights:s,cellSize:[i,i],viewport:l,changeFlags:e,useGPU:r,projectPoints:u,gridTransformMatrix:c}),h=g.color.maxData&&Number.isFinite(g.color.maxData[0])?g.color.maxData[0]:0,f={aggregationData:g.color.aggregationData,maxData:g.color.maxData};this.setState({aggregationResults:f,maxWeight:h}),t.invalidate("instanceCounts")}},{key:"_updateUniforms",value:function(e){var t=e.oldProps,n=e.props,i=e.changeFlags,r={};if(re.some(function(e){return t[e]!==n[e]})&&(r.shouldUseMinMax=this._shouldUseMinMax()),t.colorRange!==n.colorRange){var o=[];n.colorRange.forEach(function(e){o.push(e[0],e[1],e[2],e[3]||255)}),r.colorRange=o}if(t.cellMarginPixels!==n.cellMarginPixels||t.cellSizePixels!==n.cellSizePixels||i.viewportChanged){var a=this.context.viewport,s=a.width,l=a.height,u=this.props,c=u.cellSizePixels,g=u.cellMarginPixels,h=c>g?g:0;r.cellScale=new Float32Array([(c-h)/s*2,-(c-h)/l*2,1])}this.setState(r)}},{key:"_updateGridParams",value:function(){var e=this.context.viewport,t=e.width,n=e.height,i=this.props.cellSizePixels,r=this.context.gl,o=Math.ceil(t/i),a=Math.ceil(n/i),s=o*a,l=4*s*4,u=this.state.aggregationBuffer;u&&u.delete(),u=new b.Buffer(r,{byteLength:l,accessor:{size:4,type:M.a.FLOAT,divisor:1}}),this.state.weights.color.aggregationBuffer=u,this.setState({numCol:o,numRow:a,numInstances:s,aggregationBuffer:u})}}]),t}(v.Layer);ae.layerName="ScreenGridLayer",ae.defaultProps=oe;var se=function(e){return e.length},le=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:se;r()(this,e),this.sortedBins=this.getSortedBins(t,n),this.maxCount=this.getMaxCount(),this.binMap=this.getBinMap()}return a()(e,[{key:"getSortedBins",value:function(e,t){return e.reduce(function(e,n,i){var r=t(n.points);return null!=r&&e.push({i:Number.isFinite(n.index)?n.index:i,value:r,counts:n.points.length}),e},[]).sort(function(e,t){return e.value-t.value})}},{key:"getValueRange",value:function(e){var t=S()(e,2),n=t[0],i=t[1],r=this.sortedBins.length;if(!r)return[0,0];var o=Math.ceil(n/100*(r-1)),a=Math.floor(i/100*(r-1));return[this.sortedBins[o].value,this.sortedBins[a].value]}},{key:"getMaxCount",value:function(){var e=0;return this.sortedBins.forEach(function(t){return e=e>t.counts?e:t.counts}),e}},{key:"getBinMap",value:function(){return this.sortedBins.reduce(function(e,t){return Object.assign(e,y()({},t.i,t))},{})}}]),e}();function ue(e,t,n){var i=e[1]-e[0];if(i<=0)return v.log.warn("quantizeScale: invalid domain, returning range[0]")(),t[0];var r=i/t.length,o=Math.floor((n-e[0])/r);return t[Math.max(Math.min(o,t.length-1),0)]}function ce(e,t){return function(n){return ue(e,t,n)}}function ge(e,t){return function(n){return(n-e[0])/(e[1]-e[0])*(t[1]-t[0])+t[0]}}var he=6378e3;function fe(e,t,n){var i=function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0,r=1/0,o=-1/0,a=!0,s=!1,l=void 0;try{for(var u,c=t[Symbol.iterator]();!(a=(u=c.next()).done);a=!0){var g=u.value;e=i(g)[1],Number.isFinite(e)&&(r=e<r?e:r,o=e>o?e:o)}}catch(e){s=!0,l=e}finally{try{a||null==c.return||c.return()}finally{if(s)throw l}}var h=function(e,t){var n=(a=e,a/he*(180/Math.PI)),i=(r=t,o=e,o/he*(180/Math.PI)/Math.cos(r*Math.PI/180));var r,o;var a;return{yOffset:n,xOffset:i}}(n,(r+o)/2);if(h.xOffset<=0||h.yOffset<=0)return{gridHash:{},gridOffset:h};var f={},d=!0,v=!1,p=void 0;try{for(var m,y=t[Symbol.iterator]();!(d=(m=y.next()).done);d=!0){var x=m.value,b=i(x),M=S()(b,2),C=M[0],w=M[1];if(Number.isFinite(w)&&Number.isFinite(C)){var E=Math.floor((w+90)/h.yOffset),k=Math.floor((C+180)/h.xOffset),P="".concat(E,"-").concat(k);f[P]=f[P]||{count:0,points:[]},f[P].count+=1,f[P].points.push(x)}}}catch(e){v=!0,p=e}finally{try{d||null==y.return||y.return()}finally{if(v)throw p}}return{gridHash:f,gridOffset:h}}(e,t,n),r=i.gridHash,o=i.gridOffset;return{gridOffset:o,layerData:function(e,t){return Object.keys(e).reduce(function(n,i,r){var o=i.split("-"),a=parseInt(o[0],10),s=parseInt(o[1],10);return n.push(Object.assign({index:r,position:[t.xOffset*s-180,t.yOffset*a-90]},e[i])),n},[])}(r,o)}}function de(){}var ve={colorDomain:null,colorRange:p,getColorValue:{type:"accessor",value:function(e){return e.length}},lowerPercentile:{type:"number",min:0,max:100,value:0},upperPercentile:{type:"number",min:0,max:100,value:100},onSetColorDomain:de,elevationDomain:null,elevationRange:[0,1e3],getElevationValue:{type:"accessor",value:function(e){return e.length}},elevationLowerPercentile:{type:"number",min:0,max:100,value:0},elevationUpperPercentile:{type:"number",min:0,max:100,value:100},elevationScale:1,onSetElevationDomain:de,cellSize:{type:"number",min:0,max:1e3,value:1e3},coverage:{type:"number",min:0,max:1,value:1},getPosition:{type:"accessor",value:function(e){return e.position}},extruded:!1,fp64:!1,material:new b.PhongMaterial},pe=function(e){function t(){return r()(this,t),l()(this,c()(t).apply(this,arguments))}return d()(t,e),a()(t,[{key:"initializeState",value:function(){this.state={layerData:[],sortedColorBins:null,sortedElevationBins:null,colorValueDomain:null,elevationValueDomain:null,colorScaleFunc:de,elevationScaleFunc:de,dimensionUpdaters:this.getDimensionUpdaters()}}},{key:"updateState",value:function(e){var t=this,n=e.oldProps,i=e.props,r=e.changeFlags,o=this.needsReProjectPoints(n,i,r);r.dataChanged||o?this.getLayerData():(this.getDimensionChanges(n,i)||[]).forEach(function(e){return"function"==typeof e&&e.apply(t)})}},{key:"needsReProjectPoints",value:function(e,t,n){return e.cellSize!==t.cellSize||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged.getPosition)}},{key:"getDimensionUpdaters",value:function(){return{getColor:[{id:"value",triggers:["getColorValue"],updater:this.getSortedColorBins},{id:"domain",triggers:["lowerPercentile","upperPercentile"],updater:this.getColorValueDomain},{id:"scaleFunc",triggers:["colorDomain","colorRange"],updater:this.getColorScale}],getElevation:[{id:"value",triggers:["getElevationValue"],updater:this.getSortedElevationBins},{id:"domain",triggers:["elevationLowerPercentile","elevationUpperPercentile"],updater:this.getElevationValueDomain},{id:"scaleFunc",triggers:["elevationDomain","elevationRange"],updater:this.getElevationScale}]}}},{key:"getDimensionChanges",value:function(e,t){var n=this.state.dimensionUpdaters,i=[];for(var r in n){var o=n[r].find(function(n){return n.triggers.some(function(n){return e[n]!==t[n]})});o&&i.push(o.updater)}return i.length?i:null}},{key:"getPickingInfo",value:function(e){var t=e.info,n=this.state,i=n.sortedColorBins,r=n.sortedElevationBins,o=null;if(t.picked&&t.index>-1){var a=this.state.layerData[t.index],s=i.binMap[a.index]&&i.binMap[a.index].value,l=r.binMap[a.index]&&r.binMap[a.index].value;o=Object.assign({colorValue:s,elevationValue:l},a)}return Object.assign(t,{picked:Boolean(o),object:o})}},{key:"getUpdateTriggers",value:function(){var e=this,t=this.state.dimensionUpdaters,n={},i=function(i){n[i]={};var r=!0,o=!1,a=void 0;try{for(var s,l=t[i][Symbol.iterator]();!(r=(s=l.next()).done);r=!0){s.value.triggers.forEach(function(t){n[i][t]=e.props[t]})}}catch(e){o=!0,a=e}finally{try{r||null==l.return||l.return()}finally{if(o)throw a}}};for(var r in t)i(r);return n}},{key:"getLayerData",value:function(){var e=this.props,t=fe(e.data,e.cellSize,e.getPosition).layerData;this.setState({layerData:t}),this.getSortedBins()}},{key:"getValueDomain",value:function(){this.getColorValueDomain(),this.getElevationValueDomain()}},{key:"getSortedBins",value:function(){this.getSortedColorBins(),this.getSortedElevationBins()}},{key:"getSortedColorBins",value:function(){var e=this.props.getColorValue,t=new le(this.state.layerData||[],e);this.setState({sortedColorBins:t}),this.getColorValueDomain()}},{key:"getSortedElevationBins",value:function(){var e=this.props.getElevationValue,t=new le(this.state.layerData||[],e);this.setState({sortedElevationBins:t}),this.getElevationValueDomain()}},{key:"getColorValueDomain",value:function(){var e=this.props,t=e.lowerPercentile,n=e.upperPercentile,i=e.onSetColorDomain;this.state.colorValueDomain=this.state.sortedColorBins.getValueRange([t,n]),"function"==typeof i&&i(this.state.colorValueDomain),this.getColorScale()}},{key:"getElevationValueDomain",value:function(){var e=this.props,t=e.elevationLowerPercentile,n=e.elevationUpperPercentile,i=e.onSetElevationDomain;this.state.elevationValueDomain=this.state.sortedElevationBins.getValueRange([t,n]),"function"==typeof i&&i(this.state.elevationValueDomain),this.getElevationScale()}},{key:"getColorScale",value:function(){var e=this.props.colorRange,t=this.props.colorDomain||this.state.colorValueDomain;this.state.colorScaleFunc=ce(t,e)}},{key:"getElevationScale",value:function(){var e=this.props.elevationRange,t=this.props.elevationDomain||this.state.elevationValueDomain;this.state.elevationScaleFunc=ge(t,e)}},{key:"_onGetSublayerColor",value:function(e){var t=this.state,n=t.sortedColorBins,i=t.colorScaleFunc,r=t.colorValueDomain,o=n.binMap[e.index]&&n.binMap[e.index].value,a=this.props.colorDomain||r,s=o>=a[0]&&o<=a[a.length-1]?i(o):[0,0,0,0];return s[3]=Number.isFinite(s[3])?s[3]:255,s}},{key:"_onGetSublayerElevation",value:function(e){var t=this.state,n=t.sortedElevationBins,i=t.elevationScaleFunc,r=t.elevationValueDomain,o=n.binMap[e.index]&&n.binMap[e.index].value,a=this.props.elevationDomain||r;return o>=a[0]&&o<=a[a.length-1]?i(o):-1}},{key:"renderLayers",value:function(){var e=this.props,t=e.elevationScale,n=e.fp64,i=e.extruded,r=e.cellSize,o=e.coverage,a=e.material,s=e.transitions;return new(this.getSubLayerClass("grid-cell",v.GridCellLayer))({fp64:n,cellSize:r,coverage:o,material:a,elevationScale:t,extruded:i,getColor:this._onGetSublayerColor.bind(this),getElevation:this._onGetSublayerElevation.bind(this),transitions:s&&{getColor:s.getColorValue,getElevation:s.getElevationValue}},this.getSubLayerProps({id:"grid-cell",updateTriggers:this.getUpdateTriggers()}),{data:this.state.layerData})}}]),t}(v.CompositeLayer);pe.layerName="GridLayer",pe.defaultProps=ve;var me=Math.PI/3,ye=[0,me,2*me,3*me,4*me,5*me];function xe(e){return e[0]}function Se(e){return e[1]}var be=function(){var e,t,n,i=0,r=0,o=1,a=1,s=xe,l=Se;function u(e){var i,r={},o=[],a=e.length;for(i=0;i<a;++i)if(!isNaN(c=+s.call(null,u=e[i],i,e))&&!isNaN(g=+l.call(null,u,i,e))){var u,c,g,h=Math.round(g/=n),f=Math.round(c=c/t-(1&h)/2),d=g-h;if(3*Math.abs(d)>1){var v=c-f,p=f+(c<f?-1:1)/2,m=h+(g<h?-1:1),y=c-p,x=g-m;v*v+d*d>y*y+x*x&&(f=p+(1&h?1:-1)/2,h=m)}var S=f+"-"+h,b=r[S];b?b.push(u):(o.push(b=r[S]=[u]),b.x=(f+(1&h)/2)*t,b.y=h*n)}return o}function c(e){var t=0,n=0;return ye.map(function(i){var r=Math.sin(i)*e,o=-Math.cos(i)*e,a=r-t,s=o-n;return t=r,n=o,[a,s]})}return u.hexagon=function(t){return"m"+c(null==t?e:+t).join("l")+"z"},u.centers=function(){for(var s=[],l=Math.round(r/n),u=Math.round(i/t),c=l*n;c<a+e;c+=n,++l)for(var g=u*t+(1&l)*t/2;g<o+t/2;g+=t)s.push([g,c]);return s},u.mesh=function(){var t=c(e).slice(0,4).join("l");return u.centers().map(function(e){return"M"+e+"m"+t}).join("")},u.x=function(e){return arguments.length?(s=e,u):s},u.y=function(e){return arguments.length?(l=e,u):l},u.radius=function(i){return arguments.length?(t=2*(e=+i)*Math.sin(me),n=1.5*e,u):e},u.size=function(e){return arguments.length?(i=r=0,o=+e[0],a=+e[1],u):[o-i,a-r]},u.extent=function(e){return arguments.length?(i=+e[0][0],r=+e[0][1],o=+e[1][0],a=+e[1][1],u):[[i,r],[o,a]]},u.radius(1)};function Me(){}var Ce={colorDomain:null,colorRange:p,getColorValue:{type:"accessor",value:function(e){return e.length}},lowerPercentile:{type:"number",value:0,min:0,max:100},upperPercentile:{type:"number",value:100,min:0,max:100},onSetColorDomain:Me,elevationDomain:null,elevationRange:[0,1e3],getElevationValue:{type:"accessor",value:function(e){return e.length}},elevationLowerPercentile:{type:"number",value:0,min:0,max:100},elevationUpperPercentile:{type:"number",value:100,min:0,max:100},elevationScale:{type:"number",min:0,value:1},onSetElevationDomain:Me,radius:{type:"number",value:1e3,min:1},coverage:{type:"number",min:0,max:1,value:1},extruded:!1,hexagonAggregator:function(e,t){var n=e.data,i=e.radius,r=e.getPosition,o=function(e,t){var n=t.getDistanceScales().pixelsPerMeter;return e*n[0]}(i,t),a=[],s=Object(v.createIterable)(n),l=s.iterable,u=s.objectInfo,c=!0,g=!1,h=void 0;try{for(var f,d=l[Symbol.iterator]();!(c=(f=d.next()).done);c=!0){var p=f.value;u.index++,a.push(Object.assign({screenCoord:t.projectFlat(r(p,u))},p))}}catch(e){g=!0,h=e}finally{try{c||null==d.return||d.return()}finally{if(g)throw h}}return{hexagons:be().radius(o).x(function(e){return e.screenCoord[0]}).y(function(e){return e.screenCoord[1]})(a).map(function(e,n){return{position:t.unprojectFlat([e.x,e.y]),points:e,index:n}})}},getPosition:{type:"accessor",value:function(e){return e.position}},fp64:!1,material:new b.PhongMaterial},we=function(e){function t(){return r()(this,t),l()(this,c()(t).apply(this,arguments))}return d()(t,e),a()(t,[{key:"initializeState",value:function(){this.state={hexagons:[],sortedColorBins:null,sortedElevationBins:null,colorValueDomain:null,elevationValueDomain:null,colorScaleFunc:Me,elevationScaleFunc:Me,dimensionUpdaters:this.getDimensionUpdaters()}}},{key:"updateState",value:function(e){var t=this,n=e.oldProps,i=e.props,r=e.changeFlags,o=this.getDimensionChanges(n,i);r.dataChanged||this.needsReProjectPoints(n,i)?this.getHexagons():o&&o.forEach(function(e){return"function"==typeof e&&e.apply(t)})}},{key:"needsReProjectPoints",value:function(e,t){return e.radius!==t.radius||e.hexagonAggregator!==t.hexagonAggregator}},{key:"getDimensionUpdaters",value:function(){return{getColor:[{id:"value",triggers:["getColorValue"],updater:this.getSortedColorBins},{id:"domain",triggers:["lowerPercentile","upperPercentile"],updater:this.getColorValueDomain},{id:"scaleFunc",triggers:["colorDomain","colorRange"],updater:this.getColorScale}],getElevation:[{id:"value",triggers:["getElevationValue"],updater:this.getSortedElevationBins},{id:"domain",triggers:["elevationLowerPercentile","elevationUpperPercentile"],updater:this.getElevationValueDomain},{id:"scaleFunc",triggers:["elevationDomain","elevationRange"],updater:this.getElevationScale}]}}},{key:"getDimensionChanges",value:function(e,t){var n=this.state.dimensionUpdaters,i=[];for(var r in n){var o=n[r].find(function(n){return n.triggers.some(function(n){return e[n]!==t[n]})});o&&i.push(o.updater)}return i.length?i:null}},{key:"getHexagons",value:function(){var e=this.props.hexagonAggregator,t=this.context.viewport,n=e(this.props,t),i=n.hexagons,r=n.hexagonVertices;this.updateRadiusAngle(r),this.setState({hexagons:i}),this.getSortedBins()}},{key:"getPickingInfo",value:function(e){var t=e.info,n=this.state,i=n.sortedColorBins,r=n.sortedElevationBins,o=null;if(t.picked&&t.index>-1){var a=this.state.hexagons[t.index],s=i.binMap[a.index]&&i.binMap[a.index].value,l=r.binMap[a.index]&&r.binMap[a.index].value;o=Object.assign({colorValue:s,elevationValue:l},a)}return Object.assign(t,{picked:Boolean(o),object:o})}},{key:"getUpdateTriggers",value:function(){var e=this,t=this.state.dimensionUpdaters,n={},i=function(i){n[i]={};var r=!0,o=!1,a=void 0;try{for(var s,l=t[i][Symbol.iterator]();!(r=(s=l.next()).done);r=!0){s.value.triggers.forEach(function(t){n[i][t]=e.props[t]})}}catch(e){o=!0,a=e}finally{try{r||null==l.return||l.return()}finally{if(o)throw a}}};for(var r in t)i(r);return n}},{key:"updateRadiusAngle",value:function(e){var t=this.props.radius,n=90;if(Array.isArray(e)){e.length<6&&v.log.error("HexagonCellLayer: hexagonVertices needs to be an array of 6 points")();var i=e[0],r=e[3],o=this.context.viewport.getDistanceScales().pixelsPerMeter,a=this.projectFlat(i),s=this.projectFlat(r),l=a[0]-s[0],u=a[1]-s[1],c=Math.sqrt(l*l+u*u);n=Math.acos(l/c)*-Math.sign(u)/Math.PI*180+90,t=c/2/o[0]}this.setState({angle:n,radius:t})}},{key:"getValueDomain",value:function(){this.getColorValueDomain(),this.getElevationValueDomain()}},{key:"getSortedBins",value:function(){this.getSortedColorBins(),this.getSortedElevationBins()}},{key:"getSortedColorBins",value:function(){var e=this.props.getColorValue,t=new le(this.state.hexagons||[],e);this.setState({sortedColorBins:t}),this.getColorValueDomain()}},{key:"getSortedElevationBins",value:function(){var e=this.props.getElevationValue,t=new le(this.state.hexagons||[],e);this.setState({sortedElevationBins:t}),this.getElevationValueDomain()}},{key:"getColorValueDomain",value:function(){var e=this.props,t=e.lowerPercentile,n=e.upperPercentile,i=e.onSetColorDomain;t>n&&v.log.warn("HexagonLayer: lowerPercentile is bigger than upperPercentile")(),this.state.colorValueDomain=this.state.sortedColorBins.getValueRange([t,n]),"function"==typeof i&&i(this.state.colorValueDomain),this.getColorScale()}},{key:"getElevationValueDomain",value:function(){var e=this.props,t=e.elevationLowerPercentile,n=e.elevationUpperPercentile,i=e.onSetElevationDomain;this.state.elevationValueDomain=this.state.sortedElevationBins.getValueRange([t,n]),"function"==typeof i&&i(this.state.elevationValueDomain),this.getElevationScale()}},{key:"getColorScale",value:function(){var e=this.props.colorRange,t=this.props.colorDomain||this.state.colorValueDomain;this.state.colorScaleFunc=ce(t,e)}},{key:"getElevationScale",value:function(){var e=this.props.elevationRange,t=this.props.elevationDomain||this.state.elevationValueDomain;this.state.elevationScaleFunc=ge(t,e)}},{key:"_onGetSublayerColor",value:function(e){var t=this.state,n=t.sortedColorBins,i=t.colorScaleFunc,r=t.colorValueDomain,o=n.binMap[e.index]&&n.binMap[e.index].value,a=this.props.colorDomain||r,s=o>=a[0]&&o<=a[a.length-1]?i(o):[0,0,0,0];return s[3]=Number.isFinite(s[3])?s[3]:255,s}},{key:"_onGetSublayerElevation",value:function(e){var t=this.state,n=t.sortedElevationBins,i=t.elevationScaleFunc,r=t.elevationValueDomain,o=n.binMap[e.index]&&n.binMap[e.index].value,a=this.props.elevationDomain||r;return o>=a[0]&&o<=a[a.length-1]?i(o):-1}},{key:"renderLayers",value:function(){var e=this.props,t=e.elevationScale,n=e.extruded,i=e.coverage,r=e.material,o=e.fp64,a=e.transitions,s=this.state,l=s.angle,u=s.radius;return new(this.getSubLayerClass("hexagon-cell",v.ColumnLayer))({fp64:o,radius:u,diskResolution:6,elevationScale:t,angle:l,extruded:n,coverage:i,material:r,getColor:this._onGetSublayerColor.bind(this),getElevation:this._onGetSublayerElevation.bind(this),transitions:a&&{getColor:a.getColorValue,getElevation:a.getElevationValue}},this.getSubLayerProps({id:"hexagon-cell",updateTriggers:this.getUpdateTriggers()}),{data:this.state.hexagons})}}]),t}(v.CompositeLayer);we.layerName="HexagonLayer",we.defaultProps=Ce;var Ee,ke={};function Pe(e){if(!Number.isFinite(e))throw new Error("Invalid number ".concat(e));return e}function Ae(e){return Math.round(e/ke.EPSILON)*ke.EPSILON}function De(e){var t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).precision,n=void 0===t?ke.precision||4:t;return e=Ae(e),parseFloat(e.toPrecision(n))}function Oe(e){return Array.isArray(e)||ArrayBuffer.isView(e)&&void 0!==e.length}function Te(e,t){if(Oe(e)&&Oe(t)){if(e===t)return!0;if(e.length!==t.length)return!1;for(var n=0;n<e.length;++n)if(!Te(e[n],t[n]))return!1;return!0}return Math.abs(e-t)<=ke.EPSILON*Math.max(1,Math.abs(e),Math.abs(t))}ke.EPSILON=1e-12,ke.debug=!0,ke.precision=4,ke.printTypes=!1,ke.printDegrees=!1,ke.printRowMajor=!0;var Ne={N:[0,.5],E:[.5,0],S:[0,-.5],W:[-.5,0],NE:[.5,.5],NW:[-.5,.5],SE:[.5,-.5],SW:[-.5,-.5]},ze=[Ne.W,Ne.SW,Ne.S],_e=[Ne.S,Ne.SE,Ne.E],Fe=[Ne.E,Ne.NE,Ne.N],Le=[Ne.NW,Ne.W,Ne.N],Be=[[-.5,1/6],[-.5,-1/6],[-1/6,-.5],[1/6,-.5]],je=[[-1/6,-.5],[1/6,-.5],[.5,-1/6],[.5,1/6]],Re=[[.5,-1/6],[.5,1/6],[1/6,.5],[-1/6,.5]],Ie=[[-.5,1/6],[-.5,-1/6],[1/6,.5],[-1/6,.5]],We=[Ne.W,Ne.SW,Ne.SE,Ne.E],Ve=[Ne.S,Ne.SE,Ne.NE,Ne.N],Ue=[Ne.NW,Ne.W,Ne.E,Ne.NE],Ge=[Ne.NW,Ne.SW,Ne.S,Ne.N],Xe=[[-.5,1/6],[-.5,-1/6],[.5,-1/6],[.5,1/6]],Ye=[[-1/6,-.5],[1/6,-.5],[1/6,.5],[-1/6,.5]],qe=[Ne.NW,Ne.SW,Ne.SE,Ne.NE],He=[Ne.NW,Ne.SW,Ne.SE,Ne.E,Ne.N],Ze=[Ne.W,Ne.SW,Ne.SE,Ne.NE,Ne.N],Qe=[Ne.NW,Ne.W,Ne.S,Ne.SE,Ne.NE],Ke=[Ne.NW,Ne.SW,Ne.S,Ne.E,Ne.NE],Je=[Ne.NW,Ne.W,[.5,-1/6],[.5,1/6],Ne.N],$e=[[-1/6,-.5],[1/6,-.5],Ne.E,Ne.NE,Ne.N],et=[[-.5,1/6],[-.5,-1/6],Ne.S,Ne.SE,Ne.E],tt=[Ne.W,Ne.SW,Ne.S,[1/6,.5],[-1/6,.5]],nt=[Ne.NW,Ne.W,[-1/6,-.5],[1/6,-.5],Ne.N],it=[[-.5,1/6],[-.5,-1/6],Ne.E,Ne.NE,Ne.N],rt=[Ne.S,Ne.SE,Ne.E,[1/6,.5],[-1/6,.5]],ot=[Ne.W,Ne.SW,Ne.S,[.5,-1/6],[.5,1/6]],at=[Ne.W,Ne.SW,Ne.SE,Ne.E,[1/6,.5],[-1/6,.5]],st=[[-.5,1/6],[-.5,-1/6],Ne.S,Ne.SE,Ne.NE,Ne.N],lt=[Ne.NW,Ne.W,[-1/6,-.5],[1/6,-.5],Ne.E,Ne.NE],ut=[Ne.NW,Ne.SW,Ne.S,[.5,-1/6],[.5,1/6],Ne.N],ct=[Ne.W,Ne.SW,Ne.S,Ne.E,Ne.NE,Ne.N],gt=[Ne.NW,Ne.W,Ne.S,Ne.SE,Ne.E,Ne.N],ht=[[-.5,1/6],[-.5,-1/6],[-1/6,-.5],[1/6,-.5],Ne.E,Ne.NE,Ne.N],ft=[Ne.W,Ne.SW,Ne.S,[.5,-1/6],[.5,1/6],[1/6,.5],[-1/6,.5]],dt=[Ne.NW,Ne.W,[-1/6,-.5],[1/6,-.5],[.5,-1/6],[.5,1/6],Ne.N],vt=[[-.5,1/6],[-.5,-1/6],Ne.S,Ne.SE,Ne.E,[1/6,.5],[-1/6,.5]],pt=[[-.5,1/6],[-.5,-1/6],[-1/6,-.5],[1/6,-.5],[.5,-1/6],[.5,1/6],[1/6,.5],[-1/6,.5]],mt={0:[],1:[[Ne.W,Ne.S]],2:[[Ne.S,Ne.E]],3:[[Ne.W,Ne.E]],4:[[Ne.N,Ne.E]],5:{0:[[Ne.W,Ne.S],[Ne.N,Ne.E]],1:[[Ne.W,Ne.N],[Ne.S,Ne.E]]},6:[[Ne.N,Ne.S]],7:[[Ne.W,Ne.N]],8:[[Ne.W,Ne.N]],9:[[Ne.N,Ne.S]],10:{0:[[Ne.W,Ne.N],[Ne.S,Ne.E]],1:[[Ne.W,Ne.S],[Ne.N,Ne.E]]},11:[[Ne.N,Ne.E]],12:[[Ne.W,Ne.E]],13:[[Ne.S,Ne.E]],14:[[Ne.W,Ne.S]],15:[]};function yt(e){return parseInt(e,4)}var xt=(Ee={},y()(Ee,yt("0000"),[]),y()(Ee,yt("2222"),[]),y()(Ee,yt("2221"),[ze]),y()(Ee,yt("2212"),[_e]),y()(Ee,yt("2122"),[Fe]),y()(Ee,yt("1222"),[Le]),y()(Ee,yt("0001"),[ze]),y()(Ee,yt("0010"),[_e]),y()(Ee,yt("0100"),[Fe]),y()(Ee,yt("1000"),[Le]),y()(Ee,yt("2220"),[Be]),y()(Ee,yt("2202"),[je]),y()(Ee,yt("2022"),[Re]),y()(Ee,yt("0222"),[Ie]),y()(Ee,yt("0002"),[Be]),y()(Ee,yt("0020"),[je]),y()(Ee,yt("0200"),[Re]),y()(Ee,yt("2000"),[Ie]),y()(Ee,yt("0011"),[We]),y()(Ee,yt("0110"),[Ve]),y()(Ee,yt("1100"),[Ue]),y()(Ee,yt("1001"),[Ge]),y()(Ee,yt("2211"),[We]),y()(Ee,yt("2112"),[Ve]),y()(Ee,yt("1122"),[Ue]),y()(Ee,yt("1221"),[Ge]),y()(Ee,yt("2200"),[Xe]),y()(Ee,yt("2002"),[Ye]),y()(Ee,yt("0022"),[Xe]),y()(Ee,yt("0220"),[Ye]),y()(Ee,yt("1111"),[qe]),y()(Ee,yt("1211"),[He]),y()(Ee,yt("2111"),[Ze]),y()(Ee,yt("1112"),[Qe]),y()(Ee,yt("1121"),[Ke]),y()(Ee,yt("1011"),[He]),y()(Ee,yt("0111"),[Ze]),y()(Ee,yt("1110"),[Qe]),y()(Ee,yt("1101"),[Ke]),y()(Ee,yt("1200"),[Je]),y()(Ee,yt("0120"),[$e]),y()(Ee,yt("0012"),[et]),y()(Ee,yt("2001"),[tt]),y()(Ee,yt("1022"),[Je]),y()(Ee,yt("2102"),[$e]),y()(Ee,yt("2210"),[et]),y()(Ee,yt("0221"),[tt]),y()(Ee,yt("1002"),[nt]),y()(Ee,yt("2100"),[it]),y()(Ee,yt("0210"),[rt]),y()(Ee,yt("0021"),[ot]),y()(Ee,yt("1220"),[nt]),y()(Ee,yt("0122"),[it]),y()(Ee,yt("2012"),[rt]),y()(Ee,yt("2201"),[ot]),y()(Ee,yt("0211"),[at]),y()(Ee,yt("2110"),[st]),y()(Ee,yt("1102"),[lt]),y()(Ee,yt("1021"),[ut]),y()(Ee,yt("2011"),[at]),y()(Ee,yt("0112"),[st]),y()(Ee,yt("1120"),[lt]),y()(Ee,yt("1201"),[ut]),y()(Ee,yt("2101"),[ct]),y()(Ee,yt("0121"),[ct]),y()(Ee,yt("1012"),[gt]),y()(Ee,yt("1210"),[gt]),y()(Ee,yt("0101"),{0:[ze,Fe],1:[ct],2:[ct]}),y()(Ee,yt("1010"),{0:[Le,_e],1:[gt],2:[gt]}),y()(Ee,yt("2121"),{0:[ct],1:[ct],2:[ze,Fe]}),y()(Ee,yt("1212"),{0:[gt],1:[gt],2:[Le,_e]}),y()(Ee,yt("2120"),{0:[ht],1:[ht],2:[Be,Fe]}),y()(Ee,yt("2021"),{0:[ft],1:[ft],2:[ze,Re]}),y()(Ee,yt("1202"),{0:[dt],1:[dt],2:[Le,je]}),y()(Ee,yt("0212"),{0:[vt],1:[vt],2:[_e,Ie]}),y()(Ee,yt("0102"),{0:[Be,Fe],1:[ht],2:[ht]}),y()(Ee,yt("0201"),{0:[ze,Re],1:[ft],2:[ft]}),y()(Ee,yt("1020"),{0:[Le,je],1:[dt],2:[dt]}),y()(Ee,yt("2010"),{0:[_e,Ie],1:[vt],2:[vt]}),y()(Ee,yt("2020"),{0:[Ie,je],1:[pt],2:[Be,Re]}),y()(Ee,yt("0202"),{0:[Re,Be],1:[pt],2:[Ie,je]}),Ee),St={ISO_LINES:1,ISO_BANDS:2},bt={zIndex:0,zOffset:.005};function Mt(e,t){return Array.isArray(t)?e<t[0]?0:e<t[1]?1:2:e>=t?1:0}function Ct(e){var t=e.cellWeights,n=e.x,i=e.y,r=e.width,o=e.height,a=e.threshold;e.thresholdValue&&(v.log.deprecated("thresholdValue","threshold")(),a=e.thresholdValue);var s=n<0,l=n>=r-1,u=i<0,c=i>=o-1,g=s||l||u||c,h={},f={};s||c?f.top=0:(h.top=t[(i+1)*r+n],f.top=Mt(h.top,a)),l||c?f.topRight=0:(h.topRight=t[(i+1)*r+n+1],f.topRight=Mt(h.topRight,a)),l||u?f.right=0:(h.right=t[i*r+n+1],f.right=Mt(h.right,a)),s||u?f.current=0:(h.current=t[i*r+n],f.current=Mt(h.current,a));var d=f.top,p=f.topRight,m=f.right,y=f.current,x=-1;Number.isFinite(a)&&(x=d<<3|p<<2|m<<1|y),Array.isArray(a)&&(x=d<<6|p<<4|m<<2|y);var S=0;return g||(S=Mt((h.top+h.topRight+h.right+h.current)/4,a)),{code:x,meanCode:S}}function wt(e){var t=e.gridOrigin,n=e.cellSize,i=e.x,r=e.y,o=e.code,a=e.meanCode,s=e.type,l=void 0===s?St.ISO_LINES:s,u=Object.assign({},bt,e.thresholdData),c=l===St.ISO_BANDS?xt[o]:mt[o];Array.isArray(c)||(c=c[a]);var g=u.zIndex*u.zOffset,h=(i+1)*n[0],f=(r+1)*n[1],d=t[0]+h,v=t[1]+f;if(l===St.ISO_BANDS){var p=[];return c.forEach(function(e){var t=[];e.forEach(function(e){var i=d+e[0]*n[0],r=v+e[1]*n[1];t.push([i,r,g])}),p.push(t)}),p}var m=[];return c.forEach(function(e){e.forEach(function(e){var t=d+e[0]*n[0],i=v+e[1]*n[1];m.push([t,i,g])})}),m}function Et(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function kt(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Pt(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function At(e,t,n){return t&&Pt(e.prototype,t),n&&Pt(e,n),e}function Dt(e){return(Dt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ot(e){return(Ot="function"==typeof Symbol&&"symbol"===Dt(Symbol.iterator)?function(e){return Dt(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":Dt(e)})(e)}function Tt(e,t){return!t||"object"!==Ot(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Nt(e){return(Nt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function zt(e,t){return(zt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _t(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&zt(e,t)}function Ft(e){function t(){var t=Reflect.construct(e,Array.from(arguments));return Object.setPrototypeOf(t,Object.getPrototypeOf(this)),t}return t.prototype=Object.create(e.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e,t}var Lt=function(e){function t(){return kt(this,t),Tt(this,Nt(t).apply(this,arguments))}return _t(t,Ft(Array)),At(t,[{key:"clone",value:function(){return(new this.constructor).copy(this).check()}},{key:"copy",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]=e[t];return this.check()}},{key:"set",value:function(){for(var e=0;e<this.ELEMENTS;++e)this[e]=(e<0||arguments.length<=e?void 0:arguments[e])||0;return this.check()}},{key:"fromArray",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=0;n<this.ELEMENTS;++n)this[n]=e[n+t];return this.check()}},{key:"toString",value:function(){return this.formatString(ke)}},{key:"formatString",value:function(e){for(var t="",n=0;n<this.ELEMENTS;++n)t+=(n>0?", ":"")+De(this[n],e);return"".concat(e.printTypes?this.constructor.name:"","[").concat(t,"]")}},{key:"toArray",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=0;n<this.ELEMENTS;++n)e[t+n]=this[n];return e}},{key:"toFloat32Array",value:function(){return new Float32Array(this)}},{key:"equals",value:function(e){if(!e||this.length!==e.length)return!1;for(var t=0;t<this.ELEMENTS;++t)if(!Te(this[t],e[t]))return!1;return!0}},{key:"exactEquals",value:function(e){if(!e||this.length!==e.length)return!1;for(var t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}},{key:"negate",value:function(){for(var e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}},{key:"inverse",value:function(){for(var e=0;e<this.ELEMENTS;++e)this[e]=1/this[e];return this.check()}},{key:"lerp",value:function(e,t,n){void 0===n&&(n=t,t=e,e=this);for(var i=0;i<this.ELEMENTS;++i){var r=e[i];this[i]=r+n*(t[i]-r)}return this.check()}},{key:"min",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}},{key:"max",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}},{key:"clamp",value:function(e,t){for(var n=0;n<this.ELEMENTS;++n)this[n]=Math.min(Math.max(this[n],e[n]),t[n]);return this.check()}},{key:"validate",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this,t=e&&e.length===this.ELEMENTS,n=0;n<this.ELEMENTS;++n)t=t&&Number.isFinite(e[n]);return t}},{key:"check",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this;if(ke.debug&&!this.validate(e))throw new Error("math.gl: ".concat(this.constructor.name," some fields set to invalid numbers'"));return this}},{key:"sub",value:function(e){return this.subtract(e)}},{key:"setScalar",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}},{key:"addScalar",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}},{key:"subScalar",value:function(e){return this.addScalar(-e)}},{key:"multiplyScalar",value:function(e){return this.scale(e)}},{key:"divideScalar",value:function(e){return this.scale(1/e)}},{key:"clampScalar",value:function(e,t){for(var n=0;n<this.ELEMENTS;++n)this[n]=Math.min(Math.max(this[n],e),t);return this.check()}}]),t}();function Bt(e,t){return e.length===t&&e.every(Number.isFinite)}var jt=function(e,t){if(!e)throw new Error(t)},Rt=function(e){function t(){return kt(this,t),Tt(this,Nt(t).apply(this,arguments))}return _t(t,Lt),At(t,[{key:"len",value:function(){return Math.sqrt(this.lengthSquared())}},{key:"magnitude",value:function(){return Math.sqrt(this.lengthSquared())}},{key:"lengthSquared",value:function(){for(var e=0,t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}},{key:"distance",value:function(e){return Math.sqrt(this.distanceSquared(e))}},{key:"distanceSquared",value:function(e){for(var t=0,n=0;n<this.ELEMENTS;++n){var i=this[n]-e[n];t+=i*i}return Pe(t)}},{key:"dot",value:function(e){for(var t=0,n=0;n<this.ELEMENTS;++n)t+=this[n]*e[n];return Pe(t)}},{key:"normalize",value:function(){var e=this.magnitude();if(0!==e)for(var t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}},{key:"add",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0;i<t.length;i++)for(var r=t[i],o=0;o<this.ELEMENTS;++o)this[o]+=r[o];return this.check()}},{key:"subtract",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0;i<t.length;i++)for(var r=t[i],o=0;o<this.ELEMENTS;++o)this[o]-=r[o];return this.check()}},{key:"multiply",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0;i<t.length;i++)for(var r=t[i],o=0;o<this.ELEMENTS;++o)this[o]*=r[o];return this.check()}},{key:"divide",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0;i<t.length;i++)for(var r=t[i],o=0;o<this.ELEMENTS;++o)this[o]/=r[o];return this.check()}},{key:"scale",value:function(e){if(Array.isArray(e))return this.multiply(e);for(var t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}},{key:"scaleAndAdd",value:function(e,t){for(var n=0;n<this.ELEMENTS;++n)this[n]=this[n]*t+e[n];return this.check()}},{key:"lengthSq",value:function(){return this.lengthSquared()}},{key:"distanceTo",value:function(e){return this.distance(e)}},{key:"distanceToSquared",value:function(e){return this.distanceSquared(e)}},{key:"getComponent",value:function(e){return jt(e>=0&&e<this.ELEMENTS,"index is out of range"),Pe(this[e])}},{key:"setComponent",value:function(e,t){return jt(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}},{key:"addVectors",value:function(e,t){return this.copy(e).add(t)}},{key:"subVectors",value:function(e,t){return this.copy(e).subtract(t)}},{key:"multiplyVectors",value:function(e,t){return this.copy(e).multiply(t)}},{key:"addScaledVector",value:function(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}},{key:"x",get:function(){return this[0]},set:function(e){return this[0]=Pe(e)}},{key:"y",get:function(){return this[1]},set:function(e){return this[1]=Pe(e)}}]),t}(),It=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return kt(this,t),e=Tt(this,Nt(t).call(this)),Array.isArray(n)&&1===arguments.length?e.copy(n):e.set(n,i),e}return _t(t,Rt),At(t,[{key:"cross",value:function(e){var t,n,i,r;return t=this,i=e,r=(n=this)[0]*i[1]-n[1]*i[0],t[0]=t[1]=0,t[2]=r,this.check()}},{key:"horizontalAngle",value:function(){return Math.atan2(this.y,this.x)}},{key:"verticalAngle",value:function(){return Math.atan2(this.x,this.y)}},{key:"operation",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return e.apply(void 0,[this,this].concat(n)),this.check()}},{key:"ELEMENTS",get:function(){return 2}}]),t}(),Wt=[0,0,0],Vt=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return kt(this,t),e=Tt(this,Nt(t).call(this)),Array.isArray(n)&&1===arguments.length?e.copy(n):e.set(n,i,r),e}return _t(t,Rt),At(t,[{key:"angle",value:function(e){return function(e,t){var n=L(e[0],e[1],e[2]),i=L(t[0],t[1],t[2]);B(n,n),B(i,i);var r=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}(n,i);return r>1?0:r<-1?Math.PI:Math.acos(r)}(this,e)}},{key:"cross",value:function(e){var t,n,i,r,o,a,s,l,u;return t=this,i=e,r=(n=this)[0],o=n[1],a=n[2],s=i[0],l=i[1],u=i[2],t[0]=o*u-a*l,t[1]=a*s-r*u,t[2]=r*l-o*s,this.check()}},{key:"rotateX",value:function(e){var t,n,i,r,o,a,s=e.radians,l=e.origin;return t=this,i=void 0===l?Wt:l,r=s,a=[],(o=[])[0]=(n=this)[0]-i[0],o[1]=n[1]-i[1],o[2]=n[2]-i[2],a[0]=o[0],a[1]=o[1]*Math.cos(r)-o[2]*Math.sin(r),a[2]=o[1]*Math.sin(r)+o[2]*Math.cos(r),t[0]=a[0]+i[0],t[1]=a[1]+i[1],t[2]=a[2]+i[2],this.check()}},{key:"rotateY",value:function(e){var t,n,i,r,o,a,s=e.radians,l=e.origin;return t=this,i=void 0===l?Wt:l,r=s,a=[],(o=[])[0]=(n=this)[0]-i[0],o[1]=n[1]-i[1],o[2]=n[2]-i[2],a[0]=o[2]*Math.sin(r)+o[0]*Math.cos(r),a[1]=o[1],a[2]=o[2]*Math.cos(r)-o[0]*Math.sin(r),t[0]=a[0]+i[0],t[1]=a[1]+i[1],t[2]=a[2]+i[2],this.check()}},{key:"rotateZ",value:function(e){var t,n,i,r,o,a,s=e.radians,l=e.origin;return t=this,i=void 0===l?Wt:l,r=s,a=[],(o=[])[0]=(n=this)[0]-i[0],o[1]=n[1]-i[1],o[2]=n[2]-i[2],a[0]=o[0]*Math.cos(r)-o[1]*Math.sin(r),a[1]=o[0]*Math.sin(r)+o[1]*Math.cos(r),a[2]=o[2],t[0]=a[0]+i[0],t[1]=a[1]+i[1],t[2]=a[2]+i[2],this.check()}},{key:"operation",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return e.apply(void 0,[this,this].concat(n)),this.check()}},{key:"ELEMENTS",get:function(){return 3}},{key:"z",get:function(){return this[2]},set:function(e){return this[2]=Pe(e)}}]),t}(),Ut=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return kt(this,t),e=Tt(this,Nt(t).call(this)),Array.isArray(n)&&1===arguments.length?e.copy(n):e.set(n,i,r,o),e}return _t(t,Rt),At(t,[{key:"applyMatrix4",value:function(e){return e.transformVector(this,this),this}},{key:"ELEMENTS",get:function(){return 4}},{key:"z",get:function(){return this[2]},set:function(e){return this[2]=Pe(e)}},{key:"w",get:function(){return this[3]},set:function(e){return this[3]=Pe(e)}}]),t}(),Gt=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];var Xt=function(e){function t(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return kt(this,t),e=Tt(this,Nt(t).call(this)),Array.isArray(i[0])&&1===arguments.length?e.copy(i[0]):e.identity(),e}return _t(t,Lt),At(t,[{key:"setRowMajor",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,c=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,g=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,h=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,f=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,d=arguments.length>14&&void 0!==arguments[14]?arguments[14]:0,v=arguments.length>15&&void 0!==arguments[15]?arguments[15]:1;return this[0]=e,this[1]=r,this[2]=l,this[3]=h,this[4]=t,this[5]=o,this[6]=u,this[7]=f,this[8]=n,this[9]=a,this[10]=c,this[11]=d,this[12]=i,this[13]=s,this[14]=g,this[15]=v,this.check()}},{key:"setColumnMajor",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,c=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,g=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,h=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,f=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,d=arguments.length>14&&void 0!==arguments[14]?arguments[14]:0,v=arguments.length>15&&void 0!==arguments[15]?arguments[15]:1;return this[0]=e,this[1]=t,this[2]=n,this[3]=i,this[4]=r,this[5]=o,this[6]=a,this[7]=s,this[8]=l,this[9]=u,this[10]=c,this[11]=g,this[12]=h,this[13]=f,this[14]=d,this[15]=v,this.check()}},{key:"copy",value:function(e){return this.setColumnMajor.apply(this,Et(e))}},{key:"set",value:function(){return this.setColumnMajor.apply(this,arguments)}},{key:"getElement",value:function(e,t){return arguments.length>2&&void 0!==arguments[2]&&arguments[2]?this[e][t]:this[t][e]}},{key:"setElement",value:function(e,t,n){return arguments.length>3&&void 0!==arguments[3]&&arguments[3]?this[e][t]=Pe(n):this[t][e]=Pe(n),this}},{key:"determinant",value:function(){return t=(e=this)[0],n=e[1],i=e[2],r=e[3],o=e[4],a=e[5],s=e[6],l=e[7],u=e[8],c=e[9],g=e[10],h=e[11],f=e[12],d=e[13],v=e[14],p=e[15],(t*a-n*o)*(g*p-h*v)-(t*s-i*o)*(c*p-h*d)+(t*l-r*o)*(c*v-g*d)+(n*s-i*a)*(u*p-h*f)-(n*l-r*a)*(u*v-g*f)+(i*l-r*s)*(u*d-c*f);var e,t,n,i,r,o,a,s,l,u,c,g,h,f,d,v,p}},{key:"identity",value:function(){return this.copy(Gt)}},{key:"fromQuaternion",value:function(e){return function(e,t){var n=t[0],i=t[1],r=t[2],o=t[3],a=n+n,s=i+i,l=r+r,u=n*a,c=i*a,g=i*s,h=r*a,f=r*s,d=r*l,v=o*a,p=o*s,m=o*l;e[0]=1-g-d,e[1]=c+m,e[2]=h-p,e[3]=0,e[4]=c-m,e[5]=1-u-d,e[6]=f+v,e[7]=0,e[8]=h+p,e[9]=f-v,e[10]=1-u-g,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(this,e),this.check()}},{key:"frustum",value:function(e){return function(e,t,n,i,r,o,a){var s=1/(n-t),l=1/(r-i),u=1/(o-a);e[0]=2*o*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*o*l,e[6]=0,e[7]=0,e[8]=(n+t)*s,e[9]=(r+i)*l,e[10]=(a+o)*u,e[11]=-1,e[12]=0,e[13]=0,e[14]=a*o*2*u,e[15]=0}(this,e.left,e.right,e.bottom,e.top,e.near,e.far),this.check()}},{key:"lookAt",value:function(e){var t=e.eye,n=e.center,i=void 0===n?[0,0,0]:n,r=e.up;return function(e,t,n,i){var r,o,a,s,l,u,c,g,h,f,d=t[0],v=t[1],p=t[2],m=i[0],y=i[1],x=i[2],S=n[0],b=n[1],M=n[2];Math.abs(d-S)<w&&Math.abs(v-b)<w&&Math.abs(p-M)<w?function(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(e):(c=d-S,g=v-b,h=p-M,r=y*(h*=f=1/Math.sqrt(c*c+g*g+h*h))-x*(g*=f),o=x*(c*=f)-m*h,a=m*g-y*c,(f=Math.sqrt(r*r+o*o+a*a))?(r*=f=1/f,o*=f,a*=f):(r=0,o=0,a=0),s=g*a-h*o,l=h*r-c*a,u=c*o-g*r,(f=Math.sqrt(s*s+l*l+u*u))?(s*=f=1/f,l*=f,u*=f):(s=0,l=0,u=0),e[0]=r,e[1]=s,e[2]=c,e[3]=0,e[4]=o,e[5]=l,e[6]=g,e[7]=0,e[8]=a,e[9]=u,e[10]=h,e[11]=0,e[12]=-(r*d+o*v+a*p),e[13]=-(s*d+l*v+u*p),e[14]=-(c*d+g*v+h*p),e[15]=1)}(this,t,i,void 0===r?[0,1,0]:r),this.check()}},{key:"ortho",value:function(e){var t=e.left,n=e.right,i=e.bottom,r=e.top,o=e.near,a=void 0===o?.1:o,s=e.far;return function(e,t,n,i,r,o,a){var s=1/(t-n),l=1/(i-r),u=1/(o-a);e[0]=-2*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*u,e[11]=0,e[12]=(t+n)*s,e[13]=(r+i)*l,e[14]=(a+o)*u,e[15]=1}(this,t,n,i,r,a,void 0===s?500:s),this.check()}},{key:"orthographic",value:function(e){var n=e.fovy,i=void 0===n?45*Math.PI/180:n,r=e.aspect,o=void 0===r?1:r,a=e.focalDistance,s=void 0===a?1:a,l=e.near,u=void 0===l?.1:l,c=e.far,g=void 0===c?500:c;if(i>2*Math.PI)throw Error("radians");var h=i/2,f=s*Math.tan(h),d=f*o;return(new t).ortho({left:-d,right:d,bottom:-f,top:f,near:u,far:g})}},{key:"perspective",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.fovy,n=e.fov,i=void 0===n?45*Math.PI/180:n,r=e.aspect,o=void 0===r?1:r,a=e.near,s=void 0===a?.1:a,l=e.far,u=void 0===l?500:l;if((t=t||i)>2*Math.PI)throw Error("radians");return F(this,t,o,s,u),this.check()}},{key:"transpose",value:function(){return function(e,t){if(e===t){var n=t[1],i=t[2],r=t[3],o=t[6],a=t[7],s=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=n,e[6]=t[9],e[7]=t[13],e[8]=i,e[9]=o,e[11]=t[14],e[12]=r,e[13]=a,e[14]=s}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15]}(this,this),this.check()}},{key:"invert",value:function(){var e,t,n,i,r,o,a,s,l,u,c,g,h,f,d,v,p,m,y,x,S,b,M,C,w,E,k,P,A,D,O;return e=this,n=(t=this)[0],i=t[1],r=t[2],o=t[3],a=t[4],s=t[5],l=t[6],u=t[7],c=t[8],g=t[9],h=t[10],f=t[11],d=t[12],v=t[13],p=t[14],m=t[15],(O=(y=n*s-i*a)*(D=h*m-f*p)-(x=n*l-r*a)*(A=g*m-f*v)+(S=n*u-o*a)*(P=g*p-h*v)+(b=i*l-r*s)*(k=c*m-f*d)-(M=i*u-o*s)*(E=c*p-h*d)+(C=r*u-o*l)*(w=c*v-g*d))&&(O=1/O,e[0]=(s*D-l*A+u*P)*O,e[1]=(r*A-i*D-o*P)*O,e[2]=(v*C-p*M+m*b)*O,e[3]=(h*M-g*C-f*b)*O,e[4]=(l*k-a*D-u*E)*O,e[5]=(n*D-r*k+o*E)*O,e[6]=(p*S-d*C-m*x)*O,e[7]=(c*C-h*S+f*x)*O,e[8]=(a*A-s*k+u*w)*O,e[9]=(i*k-n*A-o*w)*O,e[10]=(d*M-v*S+m*y)*O,e[11]=(g*S-c*M-f*y)*O,e[12]=(s*E-a*P-l*w)*O,e[13]=(n*P-i*E+r*w)*O,e[14]=(v*x-d*b-p*y)*O,e[15]=(c*b-g*x+h*y)*O),this.check()}},{key:"multiplyLeft",value:function(e){return O(this,e,this),this.check()}},{key:"multiplyRight",value:function(e){return O(this,this,e),this.check()}},{key:"rotateX",value:function(e){return z(this,this,e),this.check()}},{key:"rotateY",value:function(e){var t,n,i,r,o,a,s,l,u,c,g,h,f;return t=this,n=this,i=e,r=Math.sin(i),o=Math.cos(i),a=n[0],s=n[1],l=n[2],u=n[3],c=n[8],g=n[9],h=n[10],f=n[11],n!==t&&(t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]),t[0]=a*o-c*r,t[1]=s*o-g*r,t[2]=l*o-h*r,t[3]=u*o-f*r,t[8]=a*r+c*o,t[9]=s*r+g*o,t[10]=l*r+h*o,t[11]=u*r+f*o,this.check()}},{key:"rotateZ",value:function(e){return _(this,this,e),this.check()}},{key:"rotateXYZ",value:function(e){var t=C(e,3),n=t[0],i=t[1],r=t[2];return this.rotateX(n).rotateY(i).rotateZ(r)}},{key:"rotateAxis",value:function(e,t){return function(e,t,n,i){var r,o,a,s,l,u,c,g,h,f,d,v,p,m,y,x,S,b,M,C,E,k,P,A,D=i[0],O=i[1],T=i[2],N=Math.sqrt(D*D+O*O+T*T);N<w||(D*=N=1/N,O*=N,T*=N,r=Math.sin(n),a=1-(o=Math.cos(n)),s=t[0],l=t[1],u=t[2],c=t[3],g=t[4],h=t[5],f=t[6],d=t[7],v=t[8],p=t[9],m=t[10],y=t[11],x=D*D*a+o,S=O*D*a+T*r,b=T*D*a-O*r,M=D*O*a-T*r,C=O*O*a+o,E=T*O*a+D*r,k=D*T*a+O*r,P=O*T*a-D*r,A=T*T*a+o,e[0]=s*x+g*S+v*b,e[1]=l*x+h*S+p*b,e[2]=u*x+f*S+m*b,e[3]=c*x+d*S+y*b,e[4]=s*M+g*C+v*E,e[5]=l*M+h*C+p*E,e[6]=u*M+f*C+m*E,e[7]=c*M+d*C+y*E,e[8]=s*k+g*P+v*A,e[9]=l*k+h*P+p*A,e[10]=u*k+f*P+m*A,e[11]=c*k+d*P+y*A,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]))}(this,this,e,t),this.check()}},{key:"scale",value:function(e){return Array.isArray(e)?N(this,this,e):N(this,this,[e,e,e]),this.check()}},{key:"translate",value:function(e){return T(this,this,e),this.check()}},{key:"transformVector2",value:function(e,t){return function(e,t,n){var i=t[0],r=t[1];e[0]=n[0]*i+n[4]*r+n[12],e[1]=n[1]*i+n[5]*r+n[13]}(t=t||new It,e,this),Bt(t,2),t}},{key:"transformVector3",value:function(e,t){return function(e,t,n){var i=t[0],r=t[1],o=t[2],a=n[3]*i+n[7]*r+n[11]*o+n[15];a=a||1,e[0]=(n[0]*i+n[4]*r+n[8]*o+n[12])/a,e[1]=(n[1]*i+n[5]*r+n[9]*o+n[13])/a,e[2]=(n[2]*i+n[6]*r+n[10]*o+n[14])/a}(t=t||new Vt,e,this),Bt(t,3),t}},{key:"transformVector4",value:function(e,t){return k(t=t||new Ut,e,this),Bt(t,4),t.check()}},{key:"transformVector",value:function(e,t){switch(e.length){case 2:return this.transformVector2(e,t);case 3:return this.transformVector3(e,t);case 4:return this.transformVector4(e,t);default:throw new Error("Illegal vector")}}},{key:"transformDirection",value:function(e,t){return this._transformVector(e,t,0)}},{key:"transformPoint",value:function(e,t){return this._transformVector(e,t,1)}},{key:"_transformVector",value:function(e,t,n){switch(e.length){case 2:k(t=t||new It,[e[0],e[1],0,n],this),t.length=2,Bt(t,2);break;case 3:k(t=t||new Vt,[e[0],e[1],e[2],n],this),t.length=3,Bt(t,3);break;case 4:if(Boolean(n)!==Boolean(e[3]))throw new Error("math.gl: Matrix4.transformPoint - invalid vector");k(t=t||new Ut,e,this),Bt(t,4);break;default:throw new Error("Illegal vector")}return t}},{key:"makeRotationX",value:function(e){return this.identity().rotateX(e)}},{key:"makeTranslation",value:function(e,t,n){return this.identity().translate([e,t,n])}},{key:"ELEMENTS",get:function(){return 16}}]),t}(),Yt=v.experimental.count,qt=b.fp64.fp64LowPart,Ht=6378e3,Zt=[1,0,0];function Qt(e){var t=e.data,n=e.getPosition,i=e.cellSizeMeters,r=e.gpuGridAggregator,o=e.gpuAggregation,a=e.aggregationFlags,s=e.getWeight,l=e.fp64,u=void 0!==l&&l,c=e.coordinateSystem,g=void 0===c?v.COORDINATE_SYSTEM.LNGLAT:c,h=e.viewport,f=void 0===h?null:h,d=e.boundingBox,p=void 0===d?null:d,m={};v.log.assert(a.dataChanged||a.cellSizeChanged||a.viewportChanged),a.dataChanged&&(p=(m=function(e,t){var n,i,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=Yt(e),a=new Float32Array(2*o),s=new Float32Array(2*o),l=new Float32Array(3*o),u=1/0,c=-1/0,g=1/0,h=-1/0,f=Object(v.createIterable)(e),d=f.iterable,p=f.objectInfo,m=!0,y=!1,x=void 0;try{for(var S,b=d[Symbol.iterator]();!(m=(S=b.next()).done);m=!0){var M=S.value;p.index++;var C=t(M,p),w=p.index;i=C[0],n=C[1],a[2*w]=i,a[2*w+1]=n,s[2*w]=qt(i),s[2*w+1]=qt(n);var E=r?r(M,p):Zt;Array.isArray(E)?(l[3*w]=E[0],l[3*w+1]=E[1],l[3*w+2]=E[2]):l[3*w]=E,Number.isFinite(n)&&Number.isFinite(i)&&(u=n<u?n:u,c=n>c?n:c,g=i<g?i:g,h=i>h?i:h)}}catch(e){y=!0,x=e}finally{try{m||null==b.return||b.return()}finally{if(y)throw x}}var k={weight1:{size:1,operation:W.SUM,needMax:!0,values:l}};return{positions:a,positions64xyLow:s,weights:k,boundingBox:{xMin:g,xMax:h,yMin:u,yMax:c}}}(t,n,s)).boundingBox);var y=[i,i],x=[0,0];switch(v.log.assert(g===v.COORDINATE_SYSTEM.LNGLAT||g===v.COORDINATE_SYSTEM.IDENTITY),g){case v.COORDINATE_SYSTEM.LNGLAT:case v.COORDINATE_SYSTEM.LNGLAT_DEPRECATED:var S=function(e,t){var n=e.yMin,i=e.yMax;return function(e,t){var n=(a=e,a/Ht*(180/Math.PI)),i=(r=t,o=e,o/Ht*(180/Math.PI)/Math.cos(r*Math.PI/180));var r,o;var a;return{yOffset:n,xOffset:i}}(t,(n+i)/2)}(p,i);y=[S.xOffset,S.yOffset],x=[-180,-90];break;case v.COORDINATE_SYSTEM.IDENTITY:x=[-f.width/2,-f.height/2];break;default:v.log.assert(!1)}var b=function(e){var t=e.boundingBox,n=e.cellSize,i=e.worldOrigin,r=t.yMin,o=t.yMax,a=t.xMin,s=t.xMax,l=Kt(a-i[0],n[0])+i[0],u=Kt(r-i[1],n[1])+i[1],c=(new Xt).translate([-1*l,-1*u,0]),g=[l,u],h=s-a+n[0],f=o-r+n[1],d=[Math.ceil(h/n[0]),Math.ceil(f/n[1])];return{gridOrigin:g,gridSize:d,width:h,height:f,gridTransformMatrix:c}}({boundingBox:p,cellSize:y,worldOrigin:x}),M=r.run({positions:m.positions,positions64xyLow:m.positions64xyLow,weights:m.weights,cellSize:y,width:b.width,height:b.height,gridTransformMatrix:b.gridTransformMatrix,useGPU:o,changeFlags:a,fp64:u});return{countsBuffer:M.weight1.aggregationBuffer,maxCountBuffer:M.weight1.maxBuffer,countsData:M.weight1.aggregationData,maxCountData:M.weight1.maxData,gridSize:b.gridSize,gridOrigin:b.gridOrigin,cellSize:y,boundingBox:p}}function Kt(e,t){var n=e<0?-1:1,i=n<0?Math.abs(e)+t:Math.abs(e);return(i=Math.floor(i/t)*t)*n}var Jt=[255,255,255,255],$t={cellSize:{type:"number",min:1,max:1e3,value:1e3},getPosition:{type:"accessor",value:function(e){return e.position}},getWeight:{type:"accessor",value:function(e){return 1}},contours:[{threshold:1}],fp64:!1,zOffset:.005},en=function(e){function t(){return r()(this,t),l()(this,c()(t).apply(this,arguments))}return d()(t,e),a()(t,[{key:"initializeState",value:function(){var e=this.context.gl,t={id:"".concat(this.id,"-gpu-aggregator"),shaderCache:this.context.shaderCache};this.state={contourData:{},gridAggregator:new ee(e,t),colorTrigger:0,strokeWidthTrigger:0}}},{key:"updateState",value:function(e){var t=e.oldProps,n=e.props,i=e.changeFlags,r=!1,o=!1,a=this._getAggregationFlags({oldProps:t,props:n,changeFlags:i});a&&(r=!0,this.setState({countsData:null}),this._aggregateData(a)),this._shouldRebuildContours({oldProps:t,props:n})&&(o=!0,this._updateThresholdData(n)),r||o?this._generateContours():this._updateSubLayerTriggers(t,n)}},{key:"finalizeState",value:function(){h()(c()(t.prototype),"finalizeState",this).call(this),this.state.gridAggregator.delete()}},{key:"renderLayers",value:function(){var e=this.state.contourData,t=e.contourSegments,n=e.contourPolygons,i=t&&t.length>0,r=n&&n.length>0;return[i&&new v.LineLayer(this._getLineLayerProps()),r&&new v.SolidPolygonLayer(this._getSolidPolygonLayerProps())]}},{key:"_aggregateData",value:function(e){var t=this.props,n=t.data,i=t.cellSize,r=t.getPosition,o=t.getWeight,a=t.gpuAggregation,s=t.fp64,l=t.coordinateSystem,u=Qt({data:n,cellSizeMeters:i,getPosition:r,getWeight:o,gpuAggregation:a,gpuGridAggregator:this.state.gridAggregator,fp64:s,coordinateSystem:l,viewport:this.context.viewport,boundingBox:this.state.boundingBox,aggregationFlags:e}),c=u.countsData,g=u.countsBuffer,h=u.gridSize,f=u.gridOrigin,d=u.cellSize,v=u.boundingBox;this.setState({countsData:c,countsBuffer:g,gridSize:h,gridOrigin:f,cellSize:d,boundingBox:v})}},{key:"_generateContours",value:function(){var e=this.state,t=e.gridSize,n=e.gridOrigin,i=e.cellSize,r=e.thresholdData,o=this.state.countsData;o||(o=this.state.countsBuffer.getData(),this.setState({countsData:o}));var a=function(e){var t=e.thresholdData,n=(e.colors,e.cellWeights),i=e.gridSize,r=e.gridOrigin,o=e.cellSize,a=[],s=[],l=i[0],u=i[1];return t.forEach(function(e,t){for(var i=e.threshold,c=-1;c<l;c++)for(var g=-1;g<u;g++){var h=Ct({cellWeights:n,threshold:i,x:c,y:g,width:l,height:u}),f=h.code,d=h.meanCode,v={gridOrigin:r,cellSize:o,x:c,y:g,width:l,height:u,code:f,meanCode:d,thresholdData:e};if(Array.isArray(i))v.type=St.ISO_BANDS,wt(v).forEach(function(e){s.push({vertices:e,threshold:i})});else{v.type=St.ISO_LINES;for(var p=wt(v),m=0;m<p.length;m+=2)a.push({start:p[m],end:p[m+1],threshold:i})}}}),{contourSegments:a,contourPolygons:s}}({thresholdData:r,cellWeights:ee.getCellData({countsData:o}).cellWeights,gridSize:t,gridOrigin:n,cellSize:i});this.setState({contourData:a})}},{key:"_getAggregationFlags",value:function(e){var t=e.oldProps,n=e.props,i=e.changeFlags,r=null;return(i.dataChanged||t.gpuAggregation!==n.gpuAggregation||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPosition))&&(r=Object.assign({},r,{dataChanged:!0})),t.cellSize!==n.cellSize&&(r=Object.assign({},r,{cellSizeChanged:!0})),r}},{key:"_getLineLayerProps",value:function(){var e=this.props.fp64,t=this.state,n=t.colorTrigger,i=t.strokeWidthTrigger;return this.getSubLayerProps({id:"contour-line-layer",data:this.state.contourData.contourSegments,fp64:e,getSourcePosition:function(e){return e.start},getTargetPosition:function(e){return e.end},getColor:this._onGetSublayerColor.bind(this),getWidth:this._onGetSublayerStrokeWidth.bind(this),widthUnits:"pixels",updateTriggers:{getColor:n,getWidth:i}})}},{key:"_getSolidPolygonLayerProps",value:function(){var e=this.props.fp64,t=this.state.colorTrigger;return this.getSubLayerProps({id:"contour-solid-polygon-layer",data:this.state.contourData.contourPolygons,fp64:e,getPolygon:function(e){return e.vertices},getFillColor:this._onGetSublayerColor.bind(this),updateTriggers:{getFillColor:t}})}},{key:"_onGetSublayerColor",value:function(e){var t=this.props.contours,n=Jt;return t.forEach(function(t){Te(t.threshold,e.threshold)&&(n=t.color||Jt)}),n}},{key:"_onGetSublayerStrokeWidth",value:function(e){var t=this.props.contours,n=1;return t.some(function(t){return t.threshold===e.threshold&&(n=t.strokeWidth||1,!0)}),n}},{key:"_shouldRebuildContours",value:function(e){var t=e.oldProps,n=e.props;if(!t.contours||!t.zOffset||t.contours.length!==n.contours.length||t.zOffset!==n.zOffset)return!0;var i=t.contours.map(function(e){return e.threshold}),r=n.contours.map(function(e){return e.threshold});return r.some(function(e,t){return!Te(r[t],i[t])})}},{key:"_updateSubLayerTriggers",value:function(e,t){e&&e.contours&&t&&t.contours&&(t.contours.some(function(t,n){return t.color!==e.contours[n].color})&&this.state.colorTrigger++,t.contours.some(function(t,n){return t.strokeWidth!==e.contours[n].strokeWidth})&&this.state.strokeWidthTrigger++)}},{key:"_updateThresholdData",value:function(e){var t=e.contours.map(function(t,n){return{threshold:t.threshold,zIndex:t.zIndex||n,zOffset:e.zOffset}});this.setState({thresholdData:t})}}]),t}(v.CompositeLayer);en.layerName="ContourLayer",en.defaultProps=$t;var tn=b.fp64.fp64LowPart,nn=new b.PhongMaterial,rn={cellSize:{type:"number",min:0,max:1e3,value:1e3},coverage:{type:"number",min:0,max:1,value:1},elevationScale:{type:"number",min:0,value:1},extruded:!0,fp64:!1,pickable:!1,minColor:{type:"color",value:[0,0,0,255]},maxColor:{type:"color",value:[0,255,0,255]},material:nn},on=function(e){function t(){return r()(this,t),l()(this,c()(t).apply(this,arguments))}return d()(t,e),a()(t,[{key:"getShaders",value:function(){return{vs:"#version 300 es\n#define SHADER_NAME gpu-grid-cell-layer-vertex-shader\n\nin vec3 positions;\nin vec3 normals;\n\nin vec4 instanceCounts;\n\n// Custom uniforms\nuniform float extruded;\nuniform float cellSize;\nuniform float coverage;\nuniform float opacity;\nuniform float elevationScale;\n\nuniform vec2 gridSize;\nuniform vec2 gridOrigin;\nuniform vec2 gridOriginLow;\nuniform vec2 gridOffset;\nuniform vec2 gridOffsetLow;\nuniform vec4 minColor;\nuniform vec4 maxColor;\nlayout(std140) uniform;\nuniform AggregationData\n{\n  vec4 maxCount;\n} aggregationData;\n\n#define ELEVATION_SCALE 100.\n\n// Result\nout vec4 vColor;\n\nvoid main(void) {\n\n  bool noRender = instanceCounts.r <= 0.0;\n\n  float step = instanceCounts.r / aggregationData.maxCount.r;\n  vec4 color = mix(minColor, maxColor, step) / 255.;\n\n  // TODO: discard when noRender is true\n  float finalCellSize = noRender ? 0.0 : project_size(cellSize);\n\n\n  float elevation = 0.0;\n\n  if (extruded > 0.5) {\n    elevation = instanceCounts.r  * (positions.z + 1.0) *\n      ELEVATION_SCALE * elevationScale;\n  }\n\n  float yIndex = floor(float(gl_InstanceID) / gridSize[0]);\n  float xIndex = float(gl_InstanceID) - (yIndex * gridSize[0]);\n\n  // Keeping 32-bit calculations for debugging, to be removed.\n  // float instancePositionX = gridOffset[0] * xIndex + gridOrigin[0];\n  // float instancePositionY = gridOffset[1] * yIndex + gridOrigin[1];\n  // vec3 extrudedPosition = vec3(instancePositionX, instancePositionY, elevation);\n  // vec2 extrudedPosition64xyLow = vec2(0., 0.);\n\n  vec2 instancePositionXFP64 = mul_fp64(vec2(gridOffset[0], gridOffsetLow[0]), vec2(xIndex, 0.));\n  instancePositionXFP64 = sum_fp64(instancePositionXFP64, vec2(gridOrigin[0], gridOriginLow[0]));\n  vec2 instancePositionYFP64 = mul_fp64(vec2(gridOffset[1], gridOffsetLow[1]), vec2(yIndex, 0.));\n  instancePositionYFP64 = sum_fp64(instancePositionYFP64, vec2(gridOrigin[1], gridOriginLow[1]));\n  vec3 extrudedPosition = vec3(instancePositionXFP64[0], instancePositionYFP64[0], elevation);\n  vec2 extrudedPosition64xyLow = vec2(instancePositionXFP64[1], instancePositionYFP64[1]);\n\n  vec3 offset = vec3(\n    (positions.x * coverage + 1.0) / 2.0 * finalCellSize,\n    (positions.y * coverage - 1.0) / 2.0 * finalCellSize,\n    1.0);\n\n  // extrude positions\n  vec4 position_commonspace;\n  gl_Position = project_position_to_clipspace(extrudedPosition, extrudedPosition64xyLow, offset, position_commonspace);\n\n   if (extruded > 0.5) {\n    vec3 lightColor = lighting_getLightColor(color.rgb, project_uCameraPosition, position_commonspace.xyz, normals);\n    vColor = vec4(lightColor, color.a * opacity);\n  } else {\n    vColor = vec4(color.rgb, color.a * opacity);\n  }\n}\n",fs:"#version 300 es\n#define SHADER_NAME gpu-grid-cell-layer-fragment-shader\n\nprecision highp float;\n\nin vec4 vColor;\n\nout vec4 fragColor;\n\nvoid main(void) {\n  fragColor = vColor;\n}\n",modules:["project32","gouraud-lighting","picking","fp64"]}}},{key:"initializeState",value:function(){this.getAttributeManager().addInstanced({instanceCounts:{size:4,update:this.calculateInstanceCounts,noAlloc:!0}})}},{key:"updateState",value:function(e){var n=e.props,i=e.oldProps,r=e.changeFlags;if(h()(c()(t.prototype),"updateState",this).call(this,{props:n,oldProps:i,changeFlags:r}),n.fp64!==i.fp64){var o=this.context.gl;this.state.model&&this.state.model.delete();var a=this._getModel(o);this._setupUniformBuffer(a),this.setState({model:a}),this.state.attributeManager.invalidate("instanceCounts")}n.countsBuffer!==i.countsBuffer&&this.state.attributeManager.invalidate("instanceCounts")}},{key:"_getModel",value:function(e){return new b.Model(e,Object.assign({},this.getShaders(),{id:this.props.id,geometry:new b.CubeGeometry,isInstanced:!0,shaderCache:this.context.shaderCache}))}},{key:"draw",value:function(e){var t=e.uniforms,n=this.props,i=n.cellSize,r=n.extruded,o=n.elevationScale,a=n.coverage,s=n.gridSize,l=n.gridOrigin,u=n.gridOffset,c=n.minColor,g=n.maxColor,h=n.maxCountBuffer,f=[tn(l[0]),tn(l[1])],d=[tn(u[0]),tn(u[1])];h.bind({target:M.a.UNIFORM_BUFFER,index:0}),this.state.model.setUniforms(Object.assign({},t,{cellSize:i,extruded:r,elevationScale:o,coverage:a,gridSize:s,gridOrigin:l,gridOriginLow:f,gridOffset:u,gridOffsetLow:d,minColor:c,maxColor:g})).draw(),h.unbind({target:M.a.UNIFORM_BUFFER,index:0})}},{key:"calculateInstanceCounts",value:function(e){var t=this.props.countsBuffer;e.update({buffer:t})}},{key:"_setupUniformBuffer",value:function(e){var t=this.context.gl,n=e.program.handle,i=t.getUniformBlockIndex(n,"AggregationData");t.uniformBlockBinding(n,i,0)}}]),t}(v.Layer);on.layerName="GPUGridCellLayer",on.defaultProps=rn;var an=[0,0,0,255],sn=[0,255,0,255],ln={elevationScale:{type:"number",min:0,value:1},cellSize:{type:"number",min:0,max:1e3,value:1e3},coverage:{type:"number",min:0,max:1,value:1},getPosition:{type:"accessor",value:function(e){return e.position}},extruded:!1,fp64:!1,pickable:!1,material:new b.PhongMaterial,gpuAggregation:!0},un=function(e){function t(){return r()(this,t),l()(this,c()(t).apply(this,arguments))}return d()(t,e),a()(t,[{key:"initializeState",value:function(){var e=this.context.gl,t={id:"".concat(this.id,"-gpu-aggregator"),shaderCache:this.context.shaderCache};this.state={gpuGridAggregator:new ee(e,t)}}},{key:"updateState",value:function(e){var t=this.getAggregationFlags(e);t&&this.getLayerData(t)}},{key:"finalizeState",value:function(){h()(c()(t.prototype),"finalizeState",this).call(this),this.state.gpuGridAggregator.delete()}},{key:"getAggregationFlags",value:function(e){var t=e.oldProps,n=e.props,i=e.changeFlags,r=null;return(i.dataChanged||t.gpuAggregation!==n.gpuAggregation||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPosition))&&(r=Object.assign({},r,{dataChanged:!0})),t.cellSize!==n.cellSize&&(r=Object.assign({},r,{cellSizeChanged:!0})),r}},{key:"getLayerData",value:function(e){var t=this.props,n=Qt({data:t.data,cellSizeMeters:t.cellSize,getPosition:t.getPosition,gpuAggregation:t.gpuAggregation,gpuGridAggregator:this.state.gpuGridAggregator,boundingBox:this.state.boundingBox,aggregationFlags:e}),i=n.countsBuffer,r=n.maxCountBuffer,o=n.gridSize,a=n.gridOrigin,s=n.cellSize,l=n.boundingBox;this.setState({countsBuffer:i,maxCountBuffer:r,gridSize:o,gridOrigin:a,cellSize:s,boundingBox:l})}},{key:"getSubLayerProps",value:function(){var e=this.props,n=e.elevationScale,i=e.fp64,r=e.extruded,o=e.cellSize,a=e.coverage,s=e.material,l=this.state,u=l.countsBuffer,g=l.maxCountBuffer,f=l.gridSize,d=l.gridOrigin,v=l.cellSize,p=an,m=sn;return h()(c()(t.prototype),"getSubLayerProps",this).call(this,{id:"grid-cell",data:this.state.layerData,countsBuffer:u,maxCountBuffer:g,gridSize:f,gridOrigin:d,gridOffset:v,numInstances:f[0]*f[1],minColor:p,maxColor:m,fp64:i,cellSize:o,coverage:a,material:s,elevationScale:n,extruded:r,pickable:!1})}},{key:"getSubLayerClass",value:function(){return on}},{key:"renderLayers",value:function(){return new(this.getSubLayerClass())(this.getSubLayerProps())}}]),t}(v.CompositeLayer);un.layerName="GPUGridLayer",un.defaultProps=ln,n.d(t,"experimental",function(){return cn}),n.d(t,"ScreenGridLayer",function(){return ae}),n.d(t,"GridLayer",function(){return pe}),n.d(t,"HexagonLayer",function(){return we}),n.d(t,"ContourLayer",function(){return en}),n.d(t,"_GPUGridLayer",function(){return un}),n.d(t,"_GPUGridAggregator",function(){return ee}),n.d(t,"AGGREGATION_OPERATION",function(){return W}),n.d(t,"_pointToDensityGridData",function(){return Qt});var cn={BinSorter:le,linearScale:function(e,t,n){return(n-e[0])/(e[1]-e[0])*(t[1]-t[0])+t[0]},getLinearScale:ge,quantizeScale:ue,getQuantizeScale:ce,defaultColorRange:p}}])});